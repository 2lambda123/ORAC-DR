# _DIVIDE_BY_FLAT_FROM_GROUP_         -*- perl -*-
#
# Divides by a flat-field. 
#
# TASK: CCDPACK - FLATCOR
#
# This should only be performed on OBJECT frames.
    if ( $Frm->hdr( "OBSTYPE" ) eq "OBJECT" ||
         $Frm->hdr( "OBSTYPE" ) eq "SKY") {

# Test whether or not it is time to make a flat.
       my $makeflat = $Frm->hdr( "MAKE_FLAT" );
       if ( $makeflat ) {

# Generate list of input and output filenames.  Inquire the number of files
# to be processed.
          (my $inref, my $outref) = $Grp->inout( "_ff" );
          my $numfiles = @$inref;

# Convert list to comma-separated list.
          my $inlist = join( ",", @$inref );
          my $outlist= join( ",", @$outref );

# Create text files to hold the list of input and output files, one per line.
# This is needed because expanded lists of files may make the command line
# too long for the ADAM message system.
          unlink( "flatcor.inlist$$", "flatcor.outlist$$" );

          open (INLIST, ">flatcor.inlist$$");
          print INLIST join( "\n", @$inref ), "\n";
          close (INLIST);

          open (OUTLIST, ">flatcor.outlist$$");
          print OUTLIST join( "\n", @$outref ), "\n";
          close (OUTLIST);

# Set the parameters for the task.
          my $header = "in=\'^flatcor.inlist$$\' flat=".$Cal->flat." out=\'^flatcor.outlist$$\'";
          my $hidden = "title=\'Flat-fielded\'";

# Flatfield all the object frames.  Generate output names from the
# input list, switching filename suffices.
          $Mon{"ccdpack_red"}->obeyw("flatcor","$header $hidden");
          unlink ("flatcor.inlist$$", "flatcor.outlist$$");

# Report the processing status.
          orac_print "Orac says: frames $inlist flat-fielded\n";

# Now update the output filenames for each member of the group.  This
# is fine until we come round again and find that we are trying to
# flat-field files that were flatfielded last time.  It is up to the
# _MAKE_FLAT_FROM_GROUP_ primitive to work out which files are meant to
# be used for input here.
          $Grp->membernames( @$outref );

       }
    }
