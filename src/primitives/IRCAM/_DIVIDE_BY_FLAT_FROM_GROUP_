#+
# Name:
#    _DIVIDE_BY_FLAT_FROM_GROUP_
#
# Purpose:
#    Flat-fields the frames within the current group.
#
# Language:
#    Perl5
#
# Description:
#    This primitive divides the frames of the current $Grp group by
#    the most-recent and matching flat-field frame from $Cal->flat
#    method.  Upon completion the group members are the flat-fielded
#    frames.
#
# Notes:
#    -  This primitive is suitable for both UFTI and IRCAM.
#    -  Processing only occurs for object and sky frames, and when
#    the steering header MAKE_FLAT is true.
#    -  The frames' titles are each propagated.
#
# Output Data:
#    -  Flat-fielded frames each inheriting its corresponding input
#    frame's name but with the _ff suffix.
#
# Tasks:
#    CCDPACK: FLATCOR.
#
# Authors:
#    MJC: Malcolm J. Currie (JAC)
#
#-

# This should only be performed on OBJECT frames.
    if ( $Frm->hdr( "OBSTYPE" ) eq "OBJECT" ||
         $Frm->hdr( "OBSTYPE" ) eq "SKY") {

# Test whether or not it is time to make a flat.
       my $makeflat = $Frm->hdr( "MAKE_FLAT" );
       if ( $makeflat ) {

# Generate list of input and output filenames.  Inquire the number of files
# to be processed.
          (my $inref, my $outref) = $Grp->inout( "_ff" );
          my $numfiles = @$inref;

# Convert list to comma-separated list.
          my $inlist = join( ",", @$inref );
          my $outlist= join( ",", @$outref );

# Create text files to hold the list of input and output files, one per line.
# This is needed because expanded lists of files may make the command line
# too long for the ADAM message system.
          unlink( "flatcor.inlist$$", "flatcor.outlist$$" );

          open (INLIST, ">flatcor.inlist$$");
          print INLIST join( "\n", @$inref ), "\n";
          close (INLIST);

          open (OUTLIST, ">flatcor.outlist$$");
          print OUTLIST join( "\n", @$outref ), "\n";
          close (OUTLIST);

# Set the parameters for the task.
          my $header = "in=\'^flatcor.inlist$$\' flat=".$Cal->flat." out=\'^flatcor.outlist$$\'";
          my $hidden = "title=!";

# Flatfield all the object frames.  Generate output names from the
# input list, switching filename suffices.
          $Mon{"ccdpack_red"}->obeyw("flatcor","$header $hidden");
          unlink ("flatcor.inlist$$", "flatcor.outlist$$");

# Report the processing status.
          orac_print "Orac says: frames $inlist flat-fielded\n";
          orac_print "Orac says: the flat-fielded frames are $outlist\n";

# Now update the output filenames for each member of the group.  This
# is fine until we come round again and find that we are trying to
# flat-field files that were flatfielded last time.  It is up to the
# _MAKE_FLAT_FROM_GROUP_ primitive to work out which files are meant to
# be used for input here.
          $Grp->membernames( @$outref );

       }
    }

# Podule
# ======

=head1 NAME

DIVIDE_BY_FLAT_FROM_GROUP -- Flat-fields the frames within the current group.

=head1 DESCRIPTION

This primitive divides the frames of the current $Grp group by
the most-recent and matching flat-field frame from $Cal->flat
method.  Upon completion the group members are the flat-fielded
frames.

=head1 NOTES

=over 4

=item *

This primitive is suitable for both UFTI and IRCAM.

=item *

Processing only occurs for object and sky frames, and when
the steering header MAKE_FLAT is true.

=item *

The frames' titles are each propagated.

=back

=head1 OUTPUT DATA

=over 4

=item *

Flat-fielded frames each inheriting its corresponding input
frame's name but with the _ff suffix.

=back

=head1 TASKS

CCDPACK: FLATCOR.

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)

=cut
