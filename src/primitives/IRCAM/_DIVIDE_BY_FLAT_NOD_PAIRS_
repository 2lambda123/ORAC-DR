# _DIVIDE_BY_FLAT_DIFFERENCED_PAIRS_   -*- perl -*-
#
# Divides the group of differenced frame pairs by the flat field.
# Used for NOD recipes.

# Test whether or not it is time to make a flat.
    my $flatdivide = $Frm->hdr( "FLAT_DIVIDE" );
    if ( $flatdivide ) {

# Make a local version of the main group, using the group of
# differenced pairs.  Then use the standard primitive which expects
# a $Grp.
       my $Grp = $Grp->uhdr( "DIFFERENCE_GROUP" );

# Obtain the cycle number.  Default to zero if undefined, so that recipes
# which do not support this feature will continue to work.
       my $cycleno = $Frm->hdr( "CYCLE_NUMBER" );
       $cycleno = defined( $cycleno ) ? $cycleno : 0;

# Select those members in the current cycle.
       my $cycleGrp = $Grp->subgrp( CYCLE_NUMBER => $cycleno );

# Loop for each of the members of the sub-group.
       foreach $Frm ( $cycleGrp->members ) {
          _DIVIDE_BY_FLAT_
       }
    }
