# _MASK_OBJECTS_     -*- perl -*-
#
# Detects objects within an image (should be approximately flat-fielded)
# and masks the objects.
#
# TASK: KAPPA - ARDMASK.
#

# Selection
# =========

# This should only be performed on OBJECT frames.
    if ($Frm->hdr(OBSTYPE) =~ /OBJECT/ || $Frm->hdr(OBSTYPE) =~ /SKY/) {

# Generate the input and output file names.
       ($in,$out) =  $Frm->inout("_om");

# Mask the objects using the ARD file
# ===================================

# Generate the ARD file name using the raw frame name.
       $maskfile = ($_MASK_OBJECTS_{MASKFILE} || $Frm->file . "_objects.ard");

# Specify the parameters.
       $header = "in=$in out=$out title=\'Objects masked\'";
       $hidden = "ardfile=$maskfile";

# Mask the object ellipses with bad pixels.
       $Mon{"kappa_mon"}->obeyw("ardmask","$header $hidden");

# Report the processing.
       orac_print "Orac says: $in to $out: objects masked\n";

# Record the new file name in the frame object.
       $Frm->file($out);                      # obligatory update step

# Display the image.
       _DISPLAY_FRAME_IMAGE_

    };
