#+
# Name:
#    _MAKE_FLAT_EXTENDED_
#
# Purpose:
#    Makes a flat from the sky frames for an EXTENDED recipe.
#
# Language:
#    Perl5
#
# Description:
#    This primitive processes sky frames in the current $Grp of an
#    EXTENDED recipe, to make a flat field.  It masks deviant pixels,
#    normalises the sky frames to each other, and combines the frames
#    using the median at each pixel.  The resultant frame is
#    normalised (to 1) to make the flat.  The flat is indexed.
#
# Notes:
#    -  This primitive is suitable for both UFTI and IRCAM.
#    -  Processing only occurs when the steering header TARGET_OR_SKY
#    is "sky".
#    -  The work is done by _MASK_DEVIANTS_, _NORMALISE_TO_MODE_EXTENDED_,
#    and _MAKE_FLAT_FROM_NORMALISED_EXTENDED_ primitives.
#
# Output Data:
#    None.  However, the invoked primitives do create new frames.  The
#    bottom line is that a flat field frame is filed and indexed.
#    Various intermediate frames are normally removed by a tidy primitive.

# Authors:
#    MJC: Malcolm J. Currie (JAC)
#
# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Test whether or not this is an object frame or a sky frame. 
    my $class = $Frm->hdr( "TARGET_OR_SKY" );

# Only perform this on sky frames.  This is an added check for all but
# _MASK_DEVIANTS_.  The other primitives called ought to do this for
# themselves.
    if ( $class eq "sky" ) {

# Mask deviant pixels, such as cosmic rays, from the sky frame.
       _MASK_DEVIANTS_

# Normalise the sky frames to each other.
       _NORMALISE_TO_MODE_EXTENDED_

# Make an approximate flat field.  Any faint sources present will bias
# the flat field.
       _MAKE_FLAT_FROM_NORMALISED_EXTENDED_
    }

# Podule
# ======

=head1 NAME

_MAKE_FLAT_EXTENDED_ -- Makes a flat from the sky frames for an EXTENDED recipe.

=head1 DESCRIPTION

This primitive processes sky frames in the current $Grp of an
EXTENDED recipe, to make a flat field.  It masks deviant pixels,
normalises the sky frames to each other, and combines the frames
using the median at each pixel.  The resultant frame is
normalised (to 1) to make the flat.  The flat is indexed.

=head1 NOTES

=over 4

=item *

This primitive is suitable for both UFTI and IRCAM.

=item *

Processing only occurs when the steering header TARGET_OR_SKY is "sky".

=item *

The work is done by _MASK_DEVIANTS_, _NORMALISE_TO_MODE_EXTENDED_,
and _MAKE_FLAT_FROM_NORMALISED_EXTENDED_ primitives.

=back

=head1 OUTPUT DATA

None.  However, the invoked primitives do create new frames.  The
bottom line is that a flat field frame is filed and indexed.
Various intermediate frames are normally removed by a tidy primitive.

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
