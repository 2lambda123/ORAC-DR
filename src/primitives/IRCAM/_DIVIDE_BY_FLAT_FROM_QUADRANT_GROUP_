# _DIVIDE_BY_FLAT_FROM_QUADRANT_GROUP_         -*- perl -*-
#
# Divides by a flat-field. 
#
# TASK: CCDPACK - FLATCOR
#
# This should only be performed on OBJECT frames.
    if ($Frm->hdr(OBSTYPE) =~ /OBJECT/) {

# Can apply the flat field when the the number of object frames is a
# multiple of four.
       if ( ( $Grp->num + 1 ) % 4 == 0 ) {

# Generate list of input and output filenames.  Inquire the number of files
# to be processed.
          ($inref, $outref) = $Grp->inout("_ff");
          $numfiles = @$inref;

# Convert list to comma-separated list.
          $inlist = join(",", @$inref);
          $outlist= join(",", @$outref);

# Create text files to hold the list of input and output files, one per line.
# This is needed because the command may be too long for a four cycle quadrant
# jitter.  Expanded lists of files may make the command line too long for the
# ADAM message system.
          unlink ("flatcor.inlist", "flatcor.outlist");
          open (INLIST, ">flatcor.inlist");
          open (OUTLIST, ">flatcor.outlist");
          for ( $i = 0; $i < $numfiles; $i++ ) {
             print INLIST @$inref[$i],"\n";
             print OUTLIST @$outref[$i],"\n";
          }
          close (INLIST);
          close (OUTLIST);

# Set the parameters for the task.
          $header = "in=\'^flatcor.inlist\' flat=".$Cal->flat." out=\'^flatcor.outlist\'";
          $hidden = "title=\'Flat-fielded\'";

# Flatfield all the object frames.  Generate output names from the
# input list, switching filename suffices.
          $ORAC_STATUS = $Mon{"ccdpack_red"}->control('par_reset');
          $Mon{"ccdpack_red"}->obeyw("flatcor","$header $hidden");
          unlink ("flatcor.inlist", "flatcor.outlist");

# Report the processing status.
          orac_print "Orac says: frames $inlist flat-fielded\n";

# Now update the output filenames for each member of the group.  This
# is fine until we come round again and find that we are trying to
# flat-field files that were flatfielded last time.  It is up to the
# _MAKE_FLAT_FROM_NORMALISED_QUADRANT_GROUP_ primitive to work out which
# files are meant to be used for input here.
          $Grp->membernames(@$outref);

       };
    };
