    # Are we allowed to do this step yet?

    if ($Grp->uhdr("TILE_COMPLETE")) {
        orac_print("Begining tile sky subtraction\n");

        # Create a sky file name

        my $skyname = sprintf("sky_%s_%05d%s",$Frm->hdr("ORACUT"),
            $Grp->name,$Frm->fitssuffix);
	my $tnum = $Grp->name;
        orac_print("Creating sky file $skyname for tile $tnum\n");

        # Create the sky file from all the files in this group (tile)

        {
	    _SKYCOMBINE_ OUT=$skyname
        }
        my $skyfrm = $Frm->new($skyname);
        _FILE_SKY_ NAME=$skyname

        # Right, now cycle through each of the files in the tile sequence.

        foreach my $frm ($Grp->allmembers) {
            my $fname = $frm->file;
            orac_print("Subtracting sky from $fname using $skyname\n");

            # Cycle through each extension 

            my $nextn = $frm->findnsubs;
            foreach my $i (1 .. $nextn) {
            
                # Get the subframe names and then do the subtraction

                my $subfrm = $frm->getasubframe($i)->file;
	        my $subskyfrm = $skyfrm->getasubframe($i)->file;
	        my ($retval,$errmsg);
	        $retval = cir_imsubt($subfrm,$subskyfrm,$errmsg);
	        if ($retval != CIR_OK) {
		    orac_err("CIR_IMSUBT: Failed in _TILE_SKYSUB_INCL_\n$errmsg\n");
		    next;
		}

                # Update the header to show that the sky subtraction is 
		# now done.

                my $line = sprintf("Done _TILE_SKYSUB_INCL_: %s",$subskyfrm);
		$retval = cir_update_hdr($subfrm,"SKYSUB","STRING",$line,
		    "",$errmsg);
            }
        }
    }


=head1 NAME

_TILE_SKYSUB_INCL_ -- Estimate and subtract sky estimates by combining images
from all jitter and microstep images from a particular tile.

=head1 DESCRIPTION

This routine only is invoked once we have all the images for a particular tile.
Once we do, we cycle through the list of images in the tile group. All the 
images in a particular tile group are used to form the mean sky. This mean file
is then used as a sky estimate for all of the images in that tile group.

=head1 ARGUMENTS

None

=head1 NOTES

None

=head1 AUTHORS

JRL: Jim Lewis (CASU, IoA)

=head1 COPYRIGHT

Copyright (C) 2004-2007 Cambridge Astronomy Survey Unit. 
All Rights Reserved

=cut


