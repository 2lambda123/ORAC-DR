    # Don't do this unless we have all the images from a particular jitter

    if ($Frm->uhdr("JITTER_COMPLETE")) {

        # Get all the files in the group and do background stats on them.

        foreach my $frm ($Grp->allmembers) {
            my $Frm = $frm;
            _IMSTAT_ CPMLOC=CIR_CPM HDRUP=1
        }

	# Get some header keywords...

	my $readkey = $Frm->hdrkeys("READNOISE");
	my $gainkey = $Frm->hdrkeys("GAIN");
	my $expkey = $Frm->hdrkeys("EXPOSURE_TIME");

        # Get a file name...

        my $outfile = "SKY_" . $Grp->name . $Frm->rawsuffix;

        # If this file already exists, then you don't need to make a new one

        if (! -e $outfile) {

            # Scale the images first

            _ICSCALE_

            # Loop for each image extension...

	    foreach my $i (1 .. $Frm->findnsubs) {

		# Get a temporary file

		my $tmpfil = ORAC::TempFile->new;
		my $fh = $tmpfil->handle;

		# Write the names of the input images to the file

		foreach my $frm ($Grp->allmembers) {
		    print $fh $frm->getasubframe($i)->file . "\n";
		}
		$fh->close;

		# Output file name specification

		my $outf = sprintf("%s[%d]",$outfile,$i);

		# Do the combination now...

		my $errmsg = "";
		my $retval = cir_imcombine($tmpfil->file,$outf,"","CIR_CPM",
		    MEDIANCALC,0,1,0,USEBPM,REJPOISSON,1,1,1,3.0,3.0,$readkey,
		    $gainkey,$expkey,$errmsg);
		if ($retval != CIR_OK) {
		    orac_err("CIR_IMCOMBINE: failed in _JITTER_SKY_\n$errmsg\n");
		    return(ORAC__ERROR);
		}
   
                # Ditch temporary file

                $tmpfil->DESTROY;
            }

            # Make a frame object from the file and add some info into the
            # header. Also, do some stats that we can use later...

            my $skyfrm = $Frm->new($outfile);
            $skyfrm->update_header("WFRTYPE",TSTRING,CALSKY,
                "Calibration frame type");
            {
                my $Frm = $skyfrm;
                _IMSTAT_ CPMLOC=CIR_CPM HDRUP=1
            }

            # File this away now...

            _FILE_SKY_ NAME=$outfile
        }

        # Now, if you haven't formed the sky here, then get it from the index.

        my $skyfil = $Cal->sky;
        my $skyfrm = $Frm->new($skyfil);            

        # Right, now do the sky subtraction. Loop for each file and each
        # image extension...

        foreach my $frm ($Grp->allmembers) {
            my $nextn = $frm->findnsubs;
            foreach my $i (1 .. $nextn) {
                my $subfrm = $frm->getasubframe($i);
                my $subskyfrm = $skyfrm->getasubframe($i);

                # Has this one already been done?

                my $isdone = $subfrm->uhdr("SKYSUB");
                next if (defined($isdone) && $isdone =~ /^Done/);

                # Find scale factor for sky frame.

                my $scfac = ($subfrm->uhdr("CIRMED"))/($subskyfrm->hdr("CIRMED"));

                # Open a file and write this info to it
                
                my $tmpfil = ORAC::TempFile->new;
                my $fh = $tmpfil->handle;
                printf $fh "%s %g\n",$subskyfrm->file,$scfac;
                $fh->close;

                # Do the subtraction

                my $errmsg = "";
                my $retval = cir_mscale_subt($subfrm->file,$tmpfil->file,
                    $subfrm->uhdr("CIRMED"),"",$errmsg);
                if ($retval != CIR_OK) {
                    orac_err("CIR_MSCALE_SUBT: failed in _JITTER_SKY_\n$errmsg\n");
                    return(ORAC__ERROR);
                }

                # Delete file...

                $tmpfil->DESTROY;

                # Add a line to the header...

                my $hline = sprintf "Done _JITTER_SKY_: %s %0.3f",
                    $subskyfrm->file,$scfac;
                $frm->getasubframe($i)->update_header("SKYSUB",TSTRING,$hline,
                    "");
                $frm->hdr("SKYSUB",$hline);
            }
        }
    }
