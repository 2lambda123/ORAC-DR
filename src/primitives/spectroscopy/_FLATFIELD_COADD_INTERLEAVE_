# -*-perl-*-

# Obtain the keyword associated with the ORAC_NSCAN_POSITIONS
# header, corresponding to the number of detetector increments.
# It is this key which is used by the flat index.
    my $nposname = "ORAC_NSCAN_POSITIONS";
    my %keywords = $Frm->translate_hdr( $nposname );
    my @nposkey = keys( %keywords );

# Obtain the name of the current flat, and a reference to its entry in
# the flat index.
    my $flat = $Cal->flat;
    my $detnincrref = $Cal->flatindex->indexentry( $flat );

# Find the number of scan positions in the flat using the derived
# keyword.
    my $detnincr = $$detnincrref{ $nposkey[ 0 ] };
    orac_print "\nFlat frame $flat will be used.\n";

    if ( $detnincr == 1 ) {
       orac_print "Flat frame $flat is undersampled.\n";
       _DIVIDE_BY_FLAT_SPECT_
       _INTERLEAVE_DETECTOR_POSITIONS_
       _COADD_MULTIPLE_EXPOSURES_

    } else {
       orac_print "Flat frame $flat is oversampled.\n";
       _INTERLEAVE_DETECTOR_POSITIONS_
       _DIVIDE_BY_FLAT_SPECT_
       _COADD_MULTIPLE_EXPOSURES_
    }

# Display the the current frame.
    $Display->display_data( $Frm ) if ( defined $Display );
