=head1 NAME

_SUBTRACT_CHOP_ - subtract the chop beams

=head1 DESCRIPTION

This primitive subtracts the two chop beams in the current frame.
Nothing happens if the observation isn't of type CHOP

If the frames are FLATs, we add (actually average) them together into
a C<_acb> file.

=head1 AUTHOR

Paul Hirst <p.hirst@jach.hawaii.edu>

=head1 COPYRIGHT

Copyright (C) 1998-2001 Particle Physics and Astronomy Research
Council. All Rights Reserved.

=cut

# Chop subtraction is only applicable to CHOP mode, oh and NDCHOP (ND_CHOP ?)

if ($Frm->uhdr("CHOPPING")) {

  my $isaflat = ($Frm->uhdr("ORAC_OBSERVATION_TYPE") eq "FLAT");

  # Process all the sub-files.
  # The sequence in the HDS is thus:
  # .I1 .I1BEAMA .I1BEAMB .I2 .I2BEAMA .I2BEAMB .I3 .I3BEAMA .I3BEAMB etc etc
  #
  # OK, but the Frame object only gives us the .BEAM data when in chop mode
  # Thus, in the loop, we see: .I1BEAMA .I1BEAMB .I2BEAMA .I2BEAMB etc
  # We keep a list of what we want in the output frame, and Update the frame
  # Object with it manually...

  my @files = ();
  my $mfiles = $Frm->nfiles / 2;


  # We use this for the averaging when "adding - actually averaging" the frames.
  my $tmp = new ORAC::TempFile;
  my $tmpfile = $tmp->file;

  foreach my $i (1 .. $mfiles) {

    # Generate the input numbers
    my $b = 2 * $i;
    my $a = $b -1;

    # Generate the input filenames.
    my ( $ina, $foo ) = $Frm->inout( "_foo", $a );
    my ( $inb, $foo ) = $Frm->inout( "_foo", $b );

    # If we're going to a single frame here, then need to know now so we create an ndf ratehr than hds
    my $out = "foo";
    if ($mfiles == 1) {
      $Frm->files($Frm->file);
      $Frm->mergehdr;
    }

    # Generate the output filename, do the maths, report
    # scb = subtracted chop beam,
    # acb = added chop beam (For FLATs)
    my $out;
    if($isaflat) {
       $out = $Frm->inout( "_acb", $i);
       $Mon{'kappa_mon'}->obeyw("add", "in1=$ina in2=$inb out=$tmpfile");
       $Mon{'kappa_mon'}->obeyw("cdiv", "in=$tmpfile scalar=2 out=$out title=$out");
       orac_print "$ina + $inb to $out: averaged chop beams\n";
    } else {
       $out = $Frm->inout( "_scb", $i);
       $Mon{'kappa_mon'}->obeyw("sub", "in1=$ina in2=$inb out=$out title=$out");
       orac_print "$ina - $inb to $out: subtracted chop beam\n";
    }

    # Note the new filename for the output frame
    push @files, $out;
  }

  # File the output frames in the Frame object
  $Frm->files(@files);

} else {
  orac_print "Not a CHOP observation; therefore no chop beam subtraction.\n";
}

# Display the frame
$Display->display_data( $Frm ) if defined $Display;

# Keep it tidy
orac_print "\n";
