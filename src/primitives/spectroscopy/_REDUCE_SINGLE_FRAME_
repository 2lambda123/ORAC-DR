=head1 NAME

_REDUCE_SINGLE_FRAME_ - Reduces a spectroscopy frame 

=head1 DESCRIPTION

Intended to be run on all OBJECT and SKY science data, and also things
like ARC frames aswell.

Contains all the steps necessary to get from raw data to a _wce file.
Variance should be propogated throughout.

This should be the first major primitive in any recipe handling on-sky
data.

=head1 PARAMETERS

An optional NOFLAT parameter, that disables flat fielding.
This is used by the _NOFLAT recipe variants and also when
reducing a flat field frame

An optional NOBIAS parameter, that diables use of a bias frame.
If we're not in an ND mode, this means that we cannot form a sensible
variance array, or of course, subtract a BIAS frame from the data.

=head1 AUTHOR

Paul Hirst <p.hirst@jach.hawaii.edu>

=head1 COPYRIGHT

Copyright (C) 1998-2001 Particle Physics and Astronomy Research
Council. All Rights Reserved.

=cut

_SPECTROSCOPY_HELLO_
_MASK_BAD_PIXELS_

# If we've been told there's no BIAS and we need one, we skip the variance and subtract_bias
my $needbias = (substr(($Frm->uhdr("ORAC_DETECTOR_READ_TYPE")), 0, 2) ne "ND" ) ? 1 : 0;
my $nobias = (defined $_REDUCE_SINGLE_FRAME_{NOBIAS}) ? 1 : 0;
if ($nobias && $needbias) {
orac_print "Need a BIAS but have been told NOBIAS, there for cannot form a variance array or subtract bias\n";
} else {
   _ADD_READNOISE_VARIANCE_
   _SUBTRACT_BIAS_
   _ADD_POISSON_VARIANCE_
}

_SUBTRACT_CHOP_

_MASK_DEVIANT_PIXELS_

# If we've been told there's no flat field, don't try to use one
if (defined $_REDUCE_SINGLE_FRAME_{NOFLAT}) {
   orac_print "NOFLAT option specified - will not flat field\n";
   _INTERLEAVE_COADD_
} else {
   _FLATFIELD_COADD_INTERLEAVE_
}

_WAVELENGTH_CALIBRATE_BY_ESTIMATION_

_DELETE_THESE_FILES_ FILES=bp,rnv,ipm
