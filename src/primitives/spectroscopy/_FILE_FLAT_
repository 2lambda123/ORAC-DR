=head1 NAME

_FILE_FLAT_ - Files a frame as the current flat for spectroscopy data.

=head1 DESCRIPTION

This generic primitive files the current frame as the current flat.
It also adds the flat to the index of flat frames.  Both steps are
reported.

=head1 NOTES

=over 4

=item *

The current frame must be a flat, otherwise a warning message appears.

=item *

The number of files in the current frame must be one.

=back

=head1 OUTPUT DATA

Frame flat_I<n>, where I<n> is the original frame number, is a copy of
of the supplied frame.

=head1 TASKS

KAPPA: NDFCOPY.

=head1 AUTHORS

Paul Hirst <p.hirst@jach.hawaii.edu>
MJC: Malcolm J. Currie (JAC)
BC: Brad Cavanagh (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2001 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut

# This is going to need changing!
if ( $Frm->nfiles == 1 ) {
  unless ( $Frm->uhdr( "ORAC_OBSERVATION_TYPE" ) eq "FLAT" ) {
     orac_warn "This is not a flat frame!  Are you running the wrong recipe?\n";
     orac_warn "The recipe continues, assuming you know what you're doing.\n";
  }


  # Obtain the current frame's number.
  my $obsnum = $Frm->uhdr( "ORAC_OBSERVATION_NUMBER" );

  # Take a copy of the current frame using a more-identifiable name.
  my $in = $Frm->file;
  my $flat = "flat_" . $obsnum;
  $Mon{ "ndfpack_mon" }->obeyw( "ndfcopy", "in=$in out=$flat" );
  
  # Store the flat as the current frame.
  $Frm->file( $flat );
  
  # File the current frame as the current flat.
  $Cal->flat( $Frm->file );
  
  # Report the processing status.
  orac_print "\n" . $Frm->file . " filed as the current flat.\n";
  
  # Add this frame to the index of flat frames.
  $Cal->flatindex->add( $Frm->file, {%{$Frm->hdr}, %{$Frm->uhdr}} );
  
  # Report the processing status.
  orac_print $Frm->file . " added to index file.\n";
  
} else {
  orac_warn "Flat frame has not been copied.  Not filed as calibration.\n";
}

