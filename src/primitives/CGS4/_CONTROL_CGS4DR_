=head1 NAME

_CONTROL_CGS4DR_ - send a REDUCE command to CGS4DR

=head1 DESCRIPTION

Command CGS4DR/QMAN to reduce the current data. This should be
called after the _EXPORT_CGS4DR_FORMAT_ primitive.

=head1 NOTES

=over 4

=item *

Creates a new object in C<%Mon> which is attached to a
QMAN monolith. This will fail if QMAN is not running.

=item *

CGS4DR must already be running on the same machine as ORAC-DR.

=back

=cut


# Connect to the monolith
# This is made harder by the fact that CGS4DR uses PID-related
# ADAM names
# QMAN is actually named  reverse($pid)_qman
# where $pid is the process ID of the parent CGS4DR_TCL task
# There are two ways to do this:
#   1. Search through the process table until I find CGS4DR_TCL
#       (Can do this with Proc::ProcessTable)
#   2. Search through ADAM_USER (or ~adam) for a pipe named
#      NNNN_qman_NNNN and extract the name from this. This is
#      okay except that we can not guarantee that ADAM_USER is
#      the same now as it was then (in fact $ENV{ADAM_USER} is
#      redefined when running ORAC-DR.

unless (exists $Mon{QMAN}) {

  # We are going to search the PID list
  require Proc::ProcessTable;
  my $procs = new Proc::ProcessTable;

  my $cgs4dr_proc;

  foreach my $proc ( @{$procs->table} ) {

    if ($proc->cmndline =~ /cgs4dr_tcl/ ) {

      # only get here if we have a valid process name
      $cgs4dr_proc = $proc;

      # Abort from the loop
      last;

    }

  }

  # Check that we have a value
  unless (defined $cgs4dr_proc) {
    orac_err "CGS4-DR does not seem to be running. Unable to talk to QMAN.\n";
    my $ORAC_STATUS = ORAC__ERROR;
  }

  # print some diagnostics
  my $uid = $cgs4dr_proc->uid;
  my $pid = $cgs4dr_proc->pid;
  orac_print "Found cgs4dr_tcl process running as PID $pid under UID $uid\n";

  # We are fine so calculate the name
  # Reverse the process id
  # Must be a more efficient way than reverse split???
  my $rpid = reverse split (//, $pid );
  my $qman = $rpid . "_qman";

  # Create the object
  $Mon{QMAN} = new Starlink::AMS::Task("$qman");

  # Try to talk to it
  unless ($Mon{QMAN}->contact) {
    orac_err "Could not talk to QMAN ($qman). Aborting\n";
    my $ORAC_STATUS = ORAC__ERROR;
  }

}


# Get the observation number [see also _EXPORT_CGS4DR_FORMAT_
# since that uses exactly the same technique
my $num = $Frm->number;
my $ut  = $Frm->hdr('ORACUT');
my $out = substr($ut, 2) . '_' . $num;

# Send the command
$Mon{QMAN}->obeyw("QMAN","write=\"REDUCE O$out\" qposition=oldest");


