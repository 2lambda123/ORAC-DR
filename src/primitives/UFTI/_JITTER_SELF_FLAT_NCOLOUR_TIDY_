#+
# Name:
#    _JITTER_SELF_FLAT_NCOLOUR_TIDY_
#
# Purpose:
#    Removes unwanted intermediate files for the JITTER_SELF_FLAT_NCOLOUR
#    recipe and its variants.
#
# Language:
#    Perl5
#
# Description:
#    Removes intermediate frames, but retaining those with the _ff suffix.
#    Files are only removed when they are no longer needed, as guided
#    by the steering headers MAKE_FLAT, MAKE_MOSAIC, and CYCLE_NUMBER.
#    Group tidying only applies to the sub-group matching the current
#    frame's filter and cycle number.
#
# Authors:
#    MJC: Malcolm J. Currie (JAC)
#
# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Removed intermediate files stored $Frm->file method.
    _DELETE_TEMP_FILES_ KEEP=_dk,_om,_ff

# Certain files can only be removed once certain steps are complete,
# and then only as a group.  So determine if it's time to remove these
# files, and obtain the cycle number.
    my $madeflat = $Frm->hdr( "MAKE_FLAT" );
    my $mademosaic = $Frm->hdr( "MAKE_MOSAIC" );
    my $cycleno = $Frm->hdr( "CYCLE_NUMBER" ); 

# Obtain the filter.
    my $filter = $Frm->hdr( "FILTER" );

# Use the filter sub-group stored by reference in the internal group
# headers.  This sub-group essentially replaces $Grp in comparison with
# _GENERATE_OFFSETS_JITTER_.
    my $filterGrp = $Grp->uhdr( $filter . "_GROUP" );

# Remove the remaining files from this cycle used to make the flat.
    my $mosGrp;
    if ( $madeflat ) {
       $mosGrp = $filterGrp->subgrp( CYCLE_NUMBER => $cycleno );
       {
          my $Grp = $mosGrp;
          _DELETE_TEMP_GROUP_FILES_ DELETE=_dk,_om,_sbp,_sc,_dg,_nm
          undef $mosGrp;
       }
    }

# Remove the remaining files from this cycle used to make the mosaic.
    if ( $mademosaic ) {
       $mosGrp = $filterGrp->subgrp( CYCLE_NUMBER => $cycleno );
       {
          my $Grp = $mosGrp;
          _DELETE_TEMP_GROUP_FILES_ DELETE=_trn
          undef $mosGrp;
       }
    }

# Podule
# ======

=head1 NAME

_JITTER_SELF_FLAT_NCOLOUR_TIDY_ -- Removes unwanted intermediate files for the JITTER_SELF_FLAT recipe and its variant.

=head1 DESCRIPTION

Removes intermediate frames, but retaining those with the _ff suffix.
Files are only removed when they are no longer needed, as guided
by the steering headers MAKE_FLAT, MAKE_MOSAIC, and CYCLE_NUMBER.
Group tidying only applies to the sub-group matching the current
frame's filter and cycle number.

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
