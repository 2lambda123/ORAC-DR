# _SUBTRACT_SKY_COMBINED_JITTER_          -*-perl-*-
#
# Subtracts a sky frame.  It ignores the sky frames, which occur after every
# NOBJFRAME object frames in the observation.
#
# TASK: CCDPACK - CALCOR
#
# This should only be performed on OBJECT frames.
    if ($Frm->hdr(OBSTYPE) =~ /OBJECT/) {

# Test whether or not it is time to subtract a sky.
       $subsky = $Frm->hdr( "SUBTRACT_SKY" );
       if ( $subsky =~ /TRUE/ ) {

# Generate the input and output filenames.  The output file has the same
# name as the input except the suffix is changed to indicate it has been
# sky subtracted.
          ($in,$out) = $Frm->inout("_ss");
          $sky = $Cal->sky;
          $header = "in=$in cal=$sky out=$out title=\'Sky subtracted\'";

# Note all sky frames and data frames should have the same exposure time.
# This is taken care of by the Cal object.  The absolute exposure times do 
# not matter, only the relative times, which here is one.
          $Mon{"ccdpack_red"}->obeyw("calcor","$header expose=1 reset accept");

# Report the processing status.
          orac_print "Orac says: $in to $out: Sky subtracted\n";

# Now update the output filename in the Frame object.
          $Frm->file($out);

# Display the image.
          _DISPLAY_FRAME_IMAGE_

       };
    };
