#+
# Name:
#    _SKY_AND_JITTER_STEER_
#
# Purpose:
#    Steers processing for SKY_AND_JITTER recipes.
#
# Language:
#    Perl5
#
# Description: 
#    This primitive control processing for SKY_AND_JITTER recipes through
#    steering headers listed below.
#
# Steering Headers:
#    CYCLE_NUMBER = INTEGER
#       Number of the cycle, a cycle being a set of frames to complete a
#       pass through the recipe.  The first cycle is 0.
#    DO_APHOT = LOGICAL
#       Whether or not perform aperture photometry.  Photometry is
#       performed once the mosaic is made.
#    FILE_SKY = LOGICAL
#       Whether or not to file the frame as sky.  This is only true for the
#       first frame in a cycle.
#    JITTER_NUMBER = INTEGER
#       The number of target frames in the jitter.
#    MAKE_MOSAIC = LOGICAL
#       Whether or not register the frames and make the mosaic.  The mosaic
#       is made once all the jittered target frames in a cycle are available.
#    SUBTRACT_SKY = LOGICAL
#       Whether or not to subtract the sky from the frame.  This is only
#       false for the first frame in a cycle.
#    TARGET_OR_SKY = CHARACTER
#       This is "target" for a target frame, and "sky" for a sky calibration
#       frame.  The first frame in the cycle is sky and the remainder
#       are targets.
#
# Arguments:
#    NUMBER = INTEGER (Given)
#       The number of frames in the jitter.  It excludes the sky
#       frame.  The minimum number is 3. [5]
#
# Notes:
#    -  This primitive is suitable for both UFTI and IRCAM.
#    -  Processing only occurs for object and sky frames.
#
# Authors:
#    MJC: Malcolm J. Currie (JAC)
#
# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# This should only be performed on OBJECT frames.
    if ( $Frm->hdr( "OBSTYPE" ) eq "OBJECT" ||
         $Frm->hdr( "OBSTYPE" ) eq "SKY" ) {

# Obtain the number of frames in the jitter pattern and sky frequency.
       my $number = max( 3, ( $_SKY_AND_JITTER_STEER_{NUMBER} || 5 ) );
       my $cycle = $number + 1;
       my $seqnum = $Grp->num % $cycle;

# Specify when to file and subtract the sky frame.  Distinguish sky and
# target frames for some primitives.  The first frame is sky, followed by
# NUMBER jitters. 
       if ( $seqnum == 0 ) {
          $Frm->hdr( "FILE_SKY", 1 );
          $Frm->hdr( "TARGET_OR_SKY", "sky" );
          $Frm->hdr( "SUBTRACT_SKY", 0 );
       } else {
          $Frm->hdr( "FILE_SKY", 0 );
          $Frm->hdr( "TARGET_OR_SKY", "target" );
          $Frm->hdr( "SUBTRACT_SKY", 1 );
       }

# Specify during processing of which frames should the objects masked,
# a mosaic created, and aperture photometry performed.
       if ( $seqnum == $number ) {
          $Frm->hdr( "MAKE_MOSAIC", 1 );
          $Frm->hdr( "DO_APHOT", 1 );

       } else {
          $Frm->hdr( "MAKE_MOSAIC", 0 );
          $Frm->hdr( "DO_APHOT", 0 );
       }

# Insert the cycle number of the set of NUMBER frames.
       $Frm->hdr( "CYCLE_NUMBER", int( $Grp->num / $cycle ) );

# Insert the number of frames in the jitter.
       $Frm->hdr( "JITTER_NUMBER", $number );

    }

# Podule
# ======

=head1 NAME

SKY_AND_JITTER_STEER -- Steers processing for SKY_AND_JITTER recipes.

=head1 DESCRIPTION

This primitive control processing for SKY_AND_JITTER recipes through
steering headers listed below.

=head1 STEERING HEADERS

=over 4

=item CYCLE_NUMBER = INTEGER

Number of the cycle, a cycle being a set of frames to complete a
pass through the recipe.  The first cycle is 0.

=item DO_APHOT = LOGICAL

Whether or not perform aperture photometry.
Photometry is performed once the mosaic is made.

=item FILE_SKY = LOGICAL

Whether or not to file the frame as sky.  This is only true for the
first frame in a cycle.

=item JITTER_NUMBER = INTEGER

The number of target frames in the jitter.

=item MAKE_MOSAIC = LOGICAL

Whether or not register the frames and make the mosaic.  The mosaic
is made once all the jittered target frames in a cycle are available.

=item SUBTRACT_SKY = LOGICAL

Whether or not to subtract the sky from the frame.  This is only
false for the first frame in a cycle.

=item TARGET_OR_SKY = CHARACTER

This is "target" for a target frame, and "sky" for a sky calibration
frame.  The first frame in the cycle is sky and the remainder are targets.

=back

=head1 ARGUMENTS

=over 4

=item NUMBER = INTEGER (Given)

The number of frames in the jitter.  It excludes the sky frame.  The
minimum number is 3. [5]

=back

=head1 NOTES

=over 4

=item *

This primitive is suitable for both UFTI and IRCAM.

=item *

Processing only occurs for object and sky frames.

=back

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
