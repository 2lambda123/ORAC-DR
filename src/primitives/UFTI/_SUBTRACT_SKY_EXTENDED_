# _SUBTRACT_SKY_EXTENDED_          -*-perl-*-
#
# Subtracts a sky frame for extended objects.
#
# TASK: KAPPA - CSUB
#
# Imports:
#    _NORMALISE_TO_MODE_EXTENDED_         : SKY_LEVEL()
#

# This should only be performed on OBJECT frames.
    if ( $Frm->hdr( "OBSTYPE" ) eq "OBJECT" ||
         $Frm->hdr( "OBSTYPE" ) eq "SKY" ) {

# Test whether or not it is time to subtract sky values.  Note this should
# only be set in the steering file when creating a mosaic.
       my $skysub = $Frm->hdr( "SUBTRACT_SKY" );
       if ( $skysub ) {

# Determine whether it is time to make a grand mosaic.
          my $grandmosaic = $Frm->hdr( "MAKE_GRAND_MOSAIC" );

# Determine whether the full mosaic is required, otherwise make the
# mosaic for the current row.
          my $tarGrp;
          if ( $grandmosaic ) {

# Form a subgroup comprising all the target frames.
             $tarGrp = $Grp->subgrp( TARGET_OR_SKY => "target" );

          } else {

# Obtain the current row number.
             my $ext_row = $Frm->hdr( "EXTENDED_ROW" );

# Form a subgroup comprising all the target frames in the current row.
             $tarGrp = $Grp->subgrp( TARGET_OR_SKY => "target",
                                     EXTENDED_ROW => $ext_row );
          }

# Form a list of the input and output target frames.
          ( my $inref, my $outref ) = $tarGrp->inout( "_ss" );

# Form the single-frame group which is the reference frame.
# This could probably be hardwired to the first frame.
          my $refGrp = $Grp->subgrp( REFERENCE_FRAME => 1 );
          my $refFrm = $refGrp->frame( 0 );
          my $skyref = $refFrm->hdr( "SKY_LEVELS" );

# Process each file in turn because there are no wildcarded file names
# in CSUB.
          foreach my $frame ( $tarGrp->members ) {

# Generate the input and output file names.
             ( my $in, my $out ) = $frame->inout( "_ss" );

# Obtain the target frame number.
             my $target_number = $frame->hdr( "TARGET_NUMBER" );

# Find the sky number corresponding to the object frame.
             my $skyindex =  $target_number + 1;

# Import the sky levels of the sky frames which just bracket the current
# observation.
             my $sky_before = $skyref->[$skyindex-1];
             my $sky_after = $skyref->[$skyindex];

# Derive the sky level for the current object frame by linear interpolation
# between the modal sky values of the pair which most closely bracket the
# object frame.  As the frequency of sky frames is fixed at two, i.e. alternting
# with sky, the interpolation assumes the object frame was taken exactly
# midway in time between its bracketing sky frames.
             my $sky_level = $sky_before - 0.5 * ( $sky_before - $sky_after );

# Specify the parameters.
             my $header = "in=$in scalar=$sky_level out=$out title=\'Sky subtracted\'";

# Note all sky frames and data frames should have the same exposure time.
# In theory we could take care of by the Cal object and the headers.
             $Mon{"kappa_mon"}->obeyw("csub","$header");

# Report the processing status.
             orac_print "Orac says: $in to $out: Sky ($sky_level) subtracted\n";

# Display the image.
             _DISPLAY_FRAME_IMAGE_

          }

# Update the target group.
          $tarGrp->membernames( @$outref );

       }
    }
