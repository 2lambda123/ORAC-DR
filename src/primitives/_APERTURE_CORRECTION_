# _APERTURE_CORRECTION_
#
# Determine the aperture photometric correction.
#
# TASK: KAPPA - STATS, CALC, APERADD
#
# Imports from:
#    _ESTIMATE_PSF_: PSFNAME

# Exports:
#    RAPTURE, CORRECTION, APERTURE, APERTURE_FACTOR
#
# This should only be performed on OBJECT frames.

print colored ("PRIMITIVE: APERTURE_CORRECTION\n",'magenta');

if ($Grp->hdr(OBSTYPE) =~ /OBJECT/) {

  # User-accessible mapping and parameters
  $user = "";
  $psfname = ($_APERTURE_CORRECTION_{PSF} || "psf$$");

  # Sum the flux within the fitted-psf image.  This should be only a
  # slight underestimate of the asymptotic flux.
  $Mon{"kappa_mon"}->obeyw("stats","$psfname accept ");
  ($fullpsf, $status ) = $Mon{"kappa_mon"}->get("stats:total");

  # Constrain supplied apertures.
  $aperture_factor = ($_APERTURE_CORRECTION_{APERTURE} || "4.5");
  $aperture_factor = min(8.0, max($aperture_factor, 3.0));
  $_APERTURE_CORRECTION_{APERTURE_FACTOR} = $aperture_factor;

  # In order to keep the aperture correction small (like under 1 percent),
  # choose an aperture many times the FWHM of the psf.
  ($fwhm, $status ) = $Mon{"kappa_mon"}->get("psf:fwhm");

  $aperture = $fwhm * $aperture_factor;
  $_APERTURE_CORRECTION_{APERTURE} = $aperture;
  $_APERTURE_CORRECTION_{RAPTURE} = $aperture * 0.5;

  # Assign the other parameters.
  # Get the PSF name from the _ESTIMATE_PSF_ primitive
  # Or override from the command line
  $psfname = ($_APERTURE_CORRECTION_{PSF} || $_ESTIMATE_PSF_{PSFNAME} || "junk");

  # Specify the other parameters for the CENTROID stage.
  $header = "inpic=$psfname";
  $hidden = "diam=$aperture";

  # Integrate the psf flux within the aperture about the image centre
  # (that's where PSF puts it).  Reset to get a new image centre.
  $Mon{"kappa_mon"}->obeyw("aperadd","$header $user $hidden reset accept ");
  #   print "Command was: aperadd $header $user $hidden reset accept \n";

  # Compute the correction factor.
  #   $partpsf = `parget total aperadd`;
  ($partpsf, $status ) = $Mon{"kappa_mon"}->get("aperadd:total");

  # Store the correction factor
  $_APERTURE_CORRECTION_{CORRECTION} = $fullpsf / $partpsf;
  print colored ("Orac says: Aperture correction: $correction\n\n",'magenta');
};
