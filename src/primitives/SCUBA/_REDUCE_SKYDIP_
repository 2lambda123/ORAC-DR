=head1 NAME

REDUCE_SKYDIP - Reduce a skydip observation

=head1 DESCRIPTION

Process skydip data and calculate the resultant tau..
If the fit is good the current value in the calibration object
is updated for each successful filter..

=head1 TASKS

Uses the SURF SKYDIP task.

=cut

# Get list of sub-instruments
@subs = $Frm->subs;
@filts = $Frm->filters;

# Get input name
my $in = $Frm->file;

# Print a header for the result printing
print "  Sub    TAUZ   ETA_TEL  B       Residual/K\n";


# Loop over sub-instruments
for ($i = 0; $i < $Frm->nsubs; $i++) {

  my $sub = $subs[$i];
  
  # Choose names for temporary output files
  # These simply contain the reduced data and are only
  # created so that we can plot the result
  my $out = "skydip_" . $sub . '_' . $Frm->number . '_sdip';
  my $model = $out . '_model';

  # Set the input arguments
  $args = "sub_instrument=$sub accept";

  # Perform the fit
  # Take default values for all fitting parameters
  # Must reset parameters between invocations - one of the parameters
  # is not cleared so the fit for 850 doesn't quite work - must
  # be some 450ness left over for eta_tel or b.
  $ORAC_STATUS = $Mon{surf_mon}->resetpars; # Reset some parameters
  $Mon{surf_mon}->obeyw('skydip',
			"in=$in out=$out model_out=$model $args");

  # Retrieve result from the monolith
  # First check that fit was good
  ($ORAC_STATUS, $goodfit) = $Mon{surf_mon}->get("skydip","goodfit");

  if ($goodfit eq 'TRUE') {

    ($ORAC_STATUS, $tauz) = $Mon{surf_mon}->get("skydip","tauz_fit");
    ($ORAC_STATUS, $etatel) = $Mon{surf_mon}->get("skydip","eta_tel_fit");
    ($ORAC_STATUS, $bfit) = $Mon{surf_mon}->get("skydip","b_fit");
    ($ORAC_STATUS, $sigma) = $Mon{surf_mon}->get("skydip","sigma");

    # Formatted string
    my $string = sprintf("%6.3f  %5.2f  %5.2f %10.1f", $tauz, $etatel, $bfit, $sigma);
  
    orac_print " $sub:\t$string [updating index]\n";

    # Update the file name in the Frame
    $Frm->file($i+1, $out);

    # Set the title so that it reflects the sub
    my $title = "Skydip: $sub";
    $Mon{ndfpack_mon}->obeyw("settitle","ndf=$out title='$title'");

    # Update the skydip value stored in the Skydip index
    # This requires that we set a couple of things in the
    # header before updating the index
    my %hdr = %{$Frm->header};
    $hdr{TAUZ} = $tauz;
    $hdr{FILTER} = uc($filts[$i]);
    $Cal->skydipindex->add($out, \%hdr);

  } else {
    orac_print "$sub:";
    orac_print "  ***** Fit failed *****\n",'red';

    # Update the file name in the frame to bad
    $Frm->file($i+1, undef);

  }

}

