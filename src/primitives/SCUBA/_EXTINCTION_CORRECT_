=head1 NAME

CORRECT_EXTINCTION

=head1 DESCRIPTION

Correct for atmospheric extinction. Note that
this routine takes one input file and outputs to
files (one for each sub-instrument).

=head1 TASKS

Uses the EXTINCTION task from SURF.

=head1 IMPORT

Retrieves the best tau from the calibration object.

=cut

@subs = $Frm->subs;
@filts = $Frm->filters;
my $in = $Frm->file;

for ($i = 0; $i < $Frm->nsubs; $i++) {

   # Set the 'input' filename in the object for the current
   # sub-instrument
   $Frm->file($i+1, $in);

   # Find current sub instrument and filter
   my $sub = $subs[$i];
   my $filter = $filts[$i];
   my $tau = $Cal->tau($filter);
   unless (defined $tau) { # Check tau
     orac_err("Error reading tau - no value received");
     $ORAC_STATUS = ORAC__ERROR;
   }

   # construct the arguments
   my $args = "sub_instrument=$sub first_tau=$tau second_tau=$tau";
   $args .= " first_lst='0' second_lst='0' ";

   # Construct the input and output filenames
   my $suffix = "_" . lc(substr($sub, 0, 3)) . "_ext";
   my ($in, $out) = $Frm->inout($suffix, $i+1);

   $Mon{surf_mon}->obeyw("extinction", "in=$in out=$out $args");
  
   $Frm->file($i+1, $out);   

   orac_print "ORAC says: Extinction corrected $sub sub-inst from $in (tau=$tau)\n";

}
