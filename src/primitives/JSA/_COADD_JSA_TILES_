# vim: syn=perl

=head1 NAME

_COADD_JSA_TILES_ - co-add JSA tiles together by tile number

=head1 DESCRIPTION

This primitive takes a set of JSA tiles and groups them by
tile number.  It then co-adds the tiles for each tile.

=head1 COPYRIGHT

Copyright (C) 2014 Science and Technology Facilities Council.
All Rights Reserved.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see L<http://www.gnu.org/licenses/>.

=cut

# Wait until we have the whole group so that we can organise the files
# by tile number.
unless ($Grp->lastmember($Frm)) {
  orac_say('Waiting for end of group');
  return ORAC__OK;
}
orac_say('Grouping by tile number');

foreach my $subgrp ($Grp->subgrps(qw/TILENUM/)) {
  my @frames = $subgrp->members();
  my $tile = $frames[0]->hdrval('TILENUM');

  # Need to determine file name to be used for the co-add,
  # probably based on the ASNID so determine the backend so
  # that we can use the corresponding frame class -- the PICARD
  # frame class doesn't know about JSA public association IDs.
  my ($prefix, $frmclass, $Frm);
  my $instrument = $frames[0]->uhdr('ORAC_INSTRUMENT');
  my $backend = $frames[0]->uhdr('ORAC_BACKEND');
  if ($backend eq 'SCUBA-2') {
    $prefix = 's';
    require 'ORAC/Frame/SCUBA2.pm';
    $frmclass = 'ORAC::Frame::SCUBA2';
  }
  elsif ($backend eq 'ACSIS') {
    $prefix = 'a';
    require 'ORAC/Frame/ACSIS.pm';
    $frmclass = 'ORAC::Frame::ACSIS';
  }
  else {
    orac_termerr("Unknown backend: ${backend}\n");
  }

  do {
    # Create new temporary frame containing the files for this tile.
    my $Frm = $frmclass->new();
    my @files = map {$_->files()} @frames;
    $Frm->configure(\@files);
    $Frm->uhdr('JSA_TILES', 1);
    $Frm->jsa_filename_bits(1);
    my $asnid = $Frm->jsa_pub_asn_id();

    # Determine output filename and title.
    my $title = "$instrument $asnid tile $tile";
    my $out = sprintf('%s%s_coadd%06d', $prefix, $asnid, $tile);

    # Mark the "coadd" file as an intermediate as we only need to
    # end up with the tagged "healpix" file.
    $Grp->push_intermediates($out);

    orac_say("Processing tile: $tile");

    if ($backend eq 'SCUBA-2') {
      _COADD_JSA_TILES_SCUBA2_ OUT=$out TITLE=$title
    }
    else {
      _COADD_JSA_TILES_ACSIS_ OUT=$out TITLE=$title
    }

    # Tag the file as the healpix product.
    _TAG_AS_REDUCED_PRODUCT_ GRAPHIC=1 UPDATE=1
  };
}
