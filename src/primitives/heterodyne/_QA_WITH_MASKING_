# -*-perl-*-

=head1 NAME

_QA_WITH_MASKING_ - Run quality assurance tests and mask out spectra
that fail a consistency check between Tsys and observed RMS.

=head1 DESCRIPTION

This primitive performs quality assurance tests on raw timeseries
data, then uses information gleaned from those tests to mask out bad
data.

=head1 ARGUMENTS

=over 4

=item MASK = STRING (Given)

When QA tests are performed, the various JCMT Legacy Surveys have
different thresholds for what counts as bad data. If this string is
set, then that given survey's thresholds will be used when masking out
data. If it is not set, then the value of the SURVEY header for the
current Frame object will be used. If that is not defined, then the
default Telescope thresholds (which are much less stringent than
survey thresholds) will be used. Case-insensitive. ['telescope']

=back

=head1 NOTES

=over 4

=item *

This primitive is suitable for ACSIS timeseries data.

=back

=head1 OUTPUT DATA

=over 4

=item *

Timeseries data sorted in time order with suffix _ts. See
_SORT_TIMESERIES_.

=item *

Masked timeseries data with suffix _tsmask.

=back

=head1 TASKS

None, but see _SORT_TIMESERIES, _QA_SENSITIVITY_VARIATION_, and
_QA_RMS_TSYS_CONSISTENCY_.

=head1 REQUIRED PERL MODULES

None.

=head1 AUTHORS

Brad Cavanagh E<lt>b.cavanagh@jach.hawaii.eduE<gt>

=head1 COPYRIGHT

Copyright (C) 2008 Science and Technology Facilities Council.  All
Rights Reserved.

=cut

_SET_SURVEY_HEADERS_

my $mask = uc( get_prim_arg( $_PRIM_ARGS_, 'MASK', $Frm->uhdr( "SURVEY_BR" ) ) );

_SORT_TIMESERIES_ GENVAR=1

_QA_SYSTEM_TEMPERATURE_

_QA_SENSITIVITY_VARIATION_

_QA_TIMESERIES_CHECK_

_QA_RMS_TSYS_CONSISTENCY_ MASK=$mask
