# -*-cperl-*-

=head1 NAME

_VERIFY_DATA_

=head1 DESCRIPTION

This primitive uses statistics to determine if any data are mostly bad,
or contain spectra comprising anomalous values.  Bad is defined as
comprising more than 85% bad values.  Anomalous values are suspected
when the standard deviation exceeds a nominal 500.

In the first case the observation is rejected.  In the second case,
thresholding is applied only to the affected sub-files, wherein the
outliers are flagged as bad.

Since some early raw data have a frequency first axis rather than the
radial velocity expected later in the recipes, the current files may
have their Axis 1 System and Units WCS attributes modified to vrad and
km/s respectively.

=head1 ARGUMENTS

=over 4

=item None

=back

=head1 NOTES

=over 4

=item The thresholding is set between -250 and 500.

=back

=head1 OUTPUT DATA

=over 4

=item A new NDF is only created if its data required outlier flagging,
and this will have suffix _thr.

=back

=head1 TASKS

KAPPA: NDFTRACE, STATS, WCSATTRIB.

=head1 REQUIRED PERL MODULES

=head1 AUTHORS

Brad Cavanagh E<lt>b.cavanagh@jach.hawaii.eduE<gt>
Malcolm J. Currie E<lt>mjc@jach.hawaii.eduE<gt>

=head1 COPYRIGHT

Copyright (C) 2009, 2013, 2016 Science and Technology Facilities Council.  All
Rights Reserved.

=cut

# For each member of the Frame, check to see if it's all bad
# pixels. If it is, remove it from processing.
my @goodfiles;
foreach my $file ( $Frm->files ) {
  $Mon{'kappa_mon'}->obeyw( "stats", "ndf=$file" );
  my( $ORAC_STATUS, $numgood ) = $Mon{'kappa_mon'}->get( "stats", "numgood" );
  ( $ORAC_STATUS, my $sigma ) = $Mon{'kappa_mon'}->get( "stats", "sigma" );
  ( $ORAC_STATUS, my $numpix ) = $Mon{'kappa_mon'}->get( "stats", "numpix" );
  my $good_fraction;
  if ($numpix>0) {
    $good_fraction = $numgood/$numpix;
  }
  if( $numgood < 1 || $sigma == 0 ) {
    orac_warn "$file has no good pixels. Removing from processing.\n";
    next;
  }
  if ( $good_fraction < 0.15 ) {
    orac_warn "$file has more than 85% bad pixels. Removing from processing. \n";
    next;
  }

# If the raw data have a large spread there might be one or more bad spectra
# present, possibly with values exceeding dex20.  These need to be masked in
# order to prevent problems from occurring later in recipes.  Apply assymmetric
# thresholds because there is likely to be positive emission.  The sigma exceeding
# 500 is arbitrary, however, outliers of a few thousand should be handled
# successfully by other primitives, whereas sufficient extreme are not rejected by
# sigma clipping can lead to nonsense statistics being determined and applied.
  if ( $sigma > 500 ) {
    my $Frm = new $Frm;
    $Frm->file( $file );
    _THRESHOLD_DATA_ LOW=-200 HIGH=500 NEWLOW=bad NEWHIGH=bad CALCMEDIAN=0
    push @goodfiles, $Frm->file;
  } else {
    push @goodfiles, $file;
  }
}

if( $#goodfiles >= 0 ) {
  $Frm->files( @goodfiles );
} else {
  orac_warn "No good data exists in current observation. Skipping to next.\n";
  return ORAC__TERM;
}

# Some raw data have a frequency first axis rather than the radial
# velocity expected later in the recipes.
foreach my $file ( @goodfiles ) {
  $Mon{ndfpack_mon}->obeyw( "ndftrace", "ndf=$file" );
  my ( $ORAC_STATUS, @funit ) = $Mon{'ndfpack_mon'}->get( "ndftrace", "funit" );

# Change the attributes to be the normal radial velocity.
  if ( lc( $funit[0] ) ne 'km/s' ) {
    ( $ORAC_STATUS, my @flabel ) = $Mon{'ndfpack_mon'}->get( "ndftrace", "flabel" );
    orac_warn "Raw data spectral axis was '$flabel[0] ($funit[0])' instead of 'Radio velocity (km/s)'\n";
    orac_warn "Attributes modified in $file to enable the recipe to function.\n";

    $Mon{ndfpack_mon}->obeyw( "wcsattrib", "ndf=$file mode=set name='system(1)' newval=vrad" );
    $Mon{ndfpack_mon}->obeyw( "wcsattrib", "ndf=$file mode=set name='unit(1)' newval=km/s" );
  }
}
