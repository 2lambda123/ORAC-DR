=head1 NAME                                     -*-perl-*-

_FRAME_MOSIAC_ - Mosiac together each f-slice within a frame 

=head1 DESCRIPTION

=head1 ARGUMENTS

=over

=item 4

=item ENCODING

=back

=head1 AUTHOR

Jamie Leech E<lt>j.leech@jach.hawaii.eduE<gt>

=head1 COPYRIGHT

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council. All Rights Reserved.

=cut

my $infile;
my $outfile;
my $i=0;
my $no_of_files_in_frame=0;

# Create a list of input and output images.
my $inputlist = "inlist.list$$";
unlink( $inputlist );

open( my $fh_inlist, ">$inputlist" ) ||
    orac_throw "Unable to open $inputlist to create a list of spectra to align. Error: $!\n";

# Determine the the number of files in this frame
$no_of_files_in_frame=scalar(@{$Frm->files});
orac_print "No. of files in frame is ".$no_of_files_in_frame."\n";

# Frequency mosiacing will only be necessary if
# there is more than 1 file in the frame
if($no_of_files_in_frame>1)
{
  foreach my $file ($Frm->files) {
     orac_print "File is $file \n";
     #$Mon{'ndfpack_mon'}->obeyw("ndftrace","ndf=$infile");
     #$Mon{ndfpack_mon}->obeyw("ndftrace $infile");
     $infile=$file;
     print $fh_inlist $infile, "\n";
     $i++;
  }

  # To generate output filename, 
  # Get first 18 characters of e.g. a20050108_00003_00_08_align
  # to give  a20050108_00003_00
  # we preserve scan number and subsystem number

  $outfile=substr($infile,0,18);
  orac_print "Output file is $outfile \n";
  # Arguments
  my $args = "in=^$inputlist noscale nozero method=mean title='Full ACSIS cube'";

  # Run CCDPACK makemos
  $Mon{ccdpack_reg}->obeyw("makemos","$args out=$outfile");
  # delete input list file
  unlink( $inputlist);

  # Now update the frame file list so that it only contains 1 file
  my @frame_array;

  $frame_array[0]=$outfile;

  $Frm->files(@frame_array);

  } else {
    orac_print "FREQ_MOSAIC - Only one file in frame - no mosaic necessary.\n";
    }
