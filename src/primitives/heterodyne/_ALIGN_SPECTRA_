# -*-cperl-*-

=head1 NAME

_ALIGN_SPECTRA_

=head1 DESCRIPTION

This primitive aligns spectra for all members of the current Group to
the first member, where each output NDF just encompasses the corresponding
input NDF.  Otherwise it uses the current parameter values for WCSALIGN.

=head1 OUTPUT DATA

=over 4

=item The aligned NDFs.  These have the suffix C<_align>.

=back

=head1 TASKS

KAPPA: WCSALIGN

=head1 AUTHORS

Brad Cavanagh E<lt>b.cavanagh@jach.hawaii.eduE<gt>
Malcolm J. Currie E<lt>mjc@star.rl.ac.ukE<gt>

=head1 COPYRIGHT

Copyright (C) 2003 Particle Physics and Astronomy Research Council.
Copyright (C) 2018 Science and Technology Facilities Council.
All Rights Reserved.

=head1 LICENCE

This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License as
published by the Free Software Foundation; either Version 3 of
the License, or (at your option) any later version.

This program is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY; without even the implied
warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR
PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public
License along with this program; if not, write to the Free
Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,
MA 02111-1307, USA.

=cut

# Get a list of all the files in the Group.
my @members = $Grp->members;

if ( scalar( @members ) > 1 ) {

  # Create a list of the input and output images in two new text files.
  my $inputlist = "inlist.list$$";
  my $outputlist = "outlist.list$$";
  unlink( $inputlist, $outputlist );

  open( my $fh_inlist, ">$inputlist" ) ||
    orac_throw "Unable to open $inputlist to create a list of spectra to align. Error: $!\n";
  open( my $fh_outlist, ">$outputlist" ) ||
    orac_throw "Unable to open $outputlist to create a list of spectra to align. Error: $!\n";

  # Write filenames to the two lists.
  foreach my $member (@members) {

    my $infile = $member->file;
    my $outfile;
    ( $outfile = $infile ) =~ s/_([a-zA-Z]+)$/_align/;

    print $fh_inlist $infile, "\n";
    print $fh_outlist $outfile, "\n";

    orac_print "$infile to $outfile: Aligning spectrum.\n";

  }

  # Close the filehandles.
  close( $fh_inlist );
  close( $fh_outlist );

  # Set up the parameters for WCSALIGN.
  my $param1 = "in='^$inputlist' out='^$outputlist' lbnd=! accept";

  # Do the align.
  $Mon{'kappa_mon'}->obeyw( "wcsalign", "$param1" );

  # Remove the filelists.
  unlink( $inputlist, $outputlist );

  # Tidy up output.
  orac_print "\n";

} else {

  orac_print "$
