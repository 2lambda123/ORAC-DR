# -*-perl-*-

=head1 NAME

_ADD_SKY_LOG_ENTRY_ - Write sky parameters log entry to disk

=head1 SYNOPSIS

_ADD_SKY_LOG_ENTRY_ DCSKY=25.0 

=head1 DESCRIPTION

Write entry to a log file with estimate of sky parameters (DC level,
slope) as obtained from the current Frame or Group file.

=head1 ARGUMENTS

The following arguments are supported

=over 4

=item B<DCSKY>

Mean DC sky level in current units. Mandatory.

=item B<GROUP>

Flag to denote whether the Group file or Frame file has been
used. Default is 0 (use the Frame file).

=item B<SKYGRAD>

Gradient in sky emission (pW per radian). A default value of 0 is
assumed if not specified.

=item B<SKYPA>

Position angle (in degrees E of N) of gradient in sky emission in AZEL
frame. A default value of 0 is assumed if not specified.

=back

=head1 EXTERNAL TASKS

The following external tasks are used:

=over 4

=item ORAC-DR PRIMITIVES:

_GET_LOG_PARAMETERS_

=back

=head1 NOTES

=over 4

=item *

One entry is written each time this primitive is called. If multiple
files are to be processed, this primitive should be called multiple
times.

=item *

Obtains header values from the current Frame or Group depending on the
value of the B<GROUP> parameter.

=back

=head1 OUTPUT FILES

Creates an output log file called C<log.sky>

=head1 LOGFILE FORMAT

The logfile has the following columns:

=over 4

=item UT

The UT date in C<YYYYMMDD.frac> format.

=item HST

The time of the observation in Hawaii.

=item Obs

The observation number.

=item Source

The source name.

=item Mode

The observing mode.

=item Filter

The specific filter associated with the fcf result.

=item Elevation

The elevation of the observation.

=item CSO

Equivalent CSO tau derived from the tau used to reduce
the observation.

=item Tau

The tau value used for the reduction.

=item Seeing

The seeing value as stored in the header.

=item DC sky

Mean sky level in current units

=item Sky gradient

Gradient in the sky emission if present, positive if increases with
increasing elevation.

=item Gradient position angle

Position angle in degrees east of north of the derived sky emission
gradient determined in the AZEL frame.

=back

=head1 AUTHOR

Andy Gibb E<lt>agg@astro.ubc.caE<gt>

Copyright (C) 2008 the University of British Columbia.  All Rights
Reserved.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,
USA,

=cut

# Read arguments
my $dcsky = get_prim_arg( $_PRIM_ARGS_, "DCSKY", undef );
unless (defined $dcsky) {
  orac_throw("ADD_SKY_LOG_ENTRY: DCSKY must be specified as an argument");
}
my $skygrad = get_prim_arg($_PRIM_ARGS_, "SKYGRAD", 0.0);
my $skypa = get_prim_arg($_PRIM_ARGS_, "SKYPA", 0.0);

my $usegroup = get_prim_arg( $_PRIM_ARGS_, "GROUP", 0);

# Create new log file if necessary
my $time = gmtime();
my $skylog = new ORAC::LogFile("log.sky");
$skylog->header("#Sky properties log file - created on $time UT",
		"#\n# UT                HST   Obs Source       Mode           Filter  El CSO    Tau  Seeing  DC_sky       Slope     PA",
		"#---------------------------------------------------------------------------------------------------------------------");


# Obtain common parameters
_GET_LOG_PARAMETERS_ GROUP=$usegroup
my ( $uttime, $hst, $obsnum, $src, $mode, $filter, $el, $cso, $tau, $see ) 
  = @{ $_GET_LOG_PARAMETERS_{PARAMS} };

# Reformat sky parameters for printing
$dcsky = sprintf "%12.7f", $dcsky;
$skygrad = sprintf "%10.7f", $skygrad;
$skypa = sprintf "%4.1f", $skypa;

# Write logfile entry
$skylog->addentry("$uttime $hst $obsnum $src $mode   $filter   $el $cso $tau $see  $dcsky $skygrad $skypa");
