=head1 NAME

_EXTINCTION_CORRECT_IMAGE_

=head1 SYNOPSIS

  _EXTINCTION_CORRECT_IMAGE_

=head1 DESCRIPTION

This primitive corrects each frame for extinction. The following
information is required:

=over 4

=item tau

The sky opacity for this filter. Different tau sources can be used
under the control of the calibration class. Default is to use the WVM
reading stored in the file. [wvm]

=item airmass

Average airmass of this frame

=item angle

The angle between Nasmyth North and elevation axis. This is just
the elevation angle.

=back



=head1 ARGUMENTS

=over 4

=back

=head1 AUTHOR

=head1 COPYRIGHT

=cut



my @out;

#my $tau = 0.1; # $Cal->tau(); # Does this return tau_183 or scaled to obs l?

my $airmass = 0.5*($Frm->uhdr("AIRMASS_START") + $Frm->uhdr("AIRMASS_END"));

my $elevation = 45; # Should get this from $airmass or elevation in header

# now use MATHS

my $tau = 1; # 

# Parameters for Kappa MATHS
my $exp = '"IA*exp(PT/sin(FB*FA))"'; # Extinction correction part 1
my $fa = '"PA+(XA*PX*sin(FB*PA)/PD)+(XB*PX*cos(FB*PA)/PD)"' # part 2
my $pi = "3.1415926535"; # Guess...
my $fb = "PI/180.0"; # For converting degrees to radians
my $pd = "3600.0";   # For converting arcsec to degrees
my $pixelscale = 3;  # In arcsec

# Correct all subframes
orac_print("Applying simple extinction correction to subarray images\n");
for my $i (1..$Frm->nfiles) {

  my ($in, $out) = $Frm->inout('_ext',$i);
  push(@out, $out);

  $Mon{kappa_mon}->obeyw("maths","exp=$exp FA=$fa FB=$fb PA=$elevation PT=$tau PD=$pd PI=$pi PX=$pixelscale IA=$in out=$out");

}

# register new file names
$Frm->files( @out );
