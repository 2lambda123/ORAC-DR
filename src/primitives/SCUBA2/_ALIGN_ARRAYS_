#! -*-perl-*-

=head1 NAME

_ALIGN_ARRAYS_ - Align all frames to first frame

=head1 SYNOPSIS

 _ALIGN_ARRAYS_

=head1 DESCRIPTION

This primitive takes all the sub-scan frames from each sub-array
and regrids them to a reference RA/Dec frame.

If a group file exists, that is the reference, else the first
frame is chosen as reference.

=head1 ARGUMENTS

=over 4

=item METHOD

Keyword specifying the method for determing how the output pixels are
populated. The default is nearest-neighbour resampling
(C<nearest>). See the documentation for WCSMOSAIC or WCSALIGN for
further details. The recommended choices are C<nearest>, C<bilinear>,
ir C<sincsinc>.

=item REBIN

A flag to determine whether to rebin or resample. Default is
resample. See the WCSMOSAIC/WCSALIGN documentation for further
information.

=back

=head1 KNOWN ISSUES

If no group file is present the primitive should create a non-rotated
RA/Dec reference based on the world coordinates of the first frame.
Currently, if the world coordinates are rotated the output aligned
frames will be rotated (as will be the case for a SCUBA-2 image
aligned with Nasmyth coordinates).

=head1 ALGORITHMS

Uses KAPPA WCSALIGN. This primitive is currently a very general
implementation.

=head1 FILE SUFFIX

Creates an output image per input image, each with a suffix of '_al'.

=head1 AUTHOR

Tim Jenness E<lt>t.jenness@jach.hawaii.eduE<gt>

=head1 COPYRIGHT

Copyright (C) 2004-2005 Particle Physics and Astronomy Research Council.
All Rights Reserved.

This program is free software; you can redistribute it and/or modify it under
the terms of the GNU General Public License as published by the Free Software
Foundation; either version 3 of the License, or (at your option) any later
version.

This program is distributed in the hope that it will be useful,but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc., 59 Temple
Place,Suite 330, Boston, MA  02111-1307, USA

=cut


# Check arguments
# Rebin or resample? Default is resample (rebin = 0).
my $rebin = (exists $_ALIGN_ARRAYS_{REBIN} &&
	     defined $_ALIGN_ARRAYS_{REBIN}) ?
             $_ALIGN_ARRAYS_{REBIN} : 0;

# Method for determining the output pixel values
my $method = (exists $_ALIGN_ARRAYS_{METHOD} &&
	      defined $_ALIGN_ARRAYS_{METHOD}) ? 
              $_ALIGN_ARRAYS_{METHOD} : "nearest"; 

# Set reference image if specified
my $ref = (exists $_ALIGN_ARRAYS_{REFIMAGE} &&
	   defined $_ALIGN_ARRAYS_{REFIMAGE}) ? 
           $_ALIGN_ARRAYS_{REFIMAGE} : "";

# If refimage not given then use Group file or first file in Frame
if ( $ref eq "" ) {
  if ($Grp->file_exists) {
    $ref = $Grp->file;
  } else {
    # Make reference NDF with correct astrometry for the tracking
    # centre of the current observation
    $ref = $Frm->file(1);
  }
}

# write alignment text file
my $intmp = new ORAC::TempFile;
my $outtmp = new ORAC::TempFile;
my @out;
for my $i (1..$Frm->nfiles) {
  print {$intmp->handle} $Frm->file($i) ."\n";
  my ($in, $out) = $Frm->inout( '_al',$i);
  push(@out, $out);
  print {$outtmp->handle}  "$out\n";
}

orac_print("Aligning subarray images\n");

$Mon{kappa_mon}->obeyw("wcsalign","ref=$ref lbnd=! ubnd=! out=^". $outtmp->file ." in=^". $intmp->file);

# register new file names
$Frm->files( @out );
