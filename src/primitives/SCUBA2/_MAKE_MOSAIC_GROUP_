=head1 NAME

_MAKE_MOSAIC_GROUP_ - Create a mosaic

=head1 SYNOPSIS



=head1 DESCRIPTION

=head1 ARGUMENTS

=over 4

=item COADD_MODE

=back

=head1 AUTHOR

=head1 COPYRIGHT

=cut


my $coadd_mode = uc($_MAKE_MOSAIC_GROUP_{COADD_MODE} || 'STACKALL');

if ($Grp->lastmember($Frm)) {

  # if the group file does not exist we can treat this as if
  # the coadd option is STACKALL
  $coadd_mode = 'STACKALL' unless $Grp->file_exists;

  # write input text file
  my $intmp = new ORAC::TempFile;

  if ($coadd_mode eq 'RUNNING') {
    if ($Grp->file_exists) {
      print {$intmp->handle} $Grp->file ."\n";

      for my $fname ($Frm->files) {
	print {$intmp->handle} $fname ."\n";
      }
    } else {
      orac_warn "Managed to get into RUNNING average without a group file";
    }

  } elsif ($coadd_mode eq 'STACKALL') {
    # combine all the frames from all the groups
    for my $f ($Grp->members) {
      for my $fname ($f->files) {
	print {$intmp->handle} $fname ."\n";
      }
    }
  } else {
    orac_err("Unrecognized COADD_MODE ($coadd_mode).");
    my $ORAC_STATUS = ORAC__ERROR;
  }

  my $out = $Grp->file;
  $out .= "_mos" unless $out =~ /_mos$/; # horrible hack KLUGE

  my $tmpobj = new ORAC::TempFile(0);
  my $tmpout = $tmpobj->file;

  $Mon{ccdpack_reg}->obeyw("makemos","in=^".$intmp->file." nousevar nozero noscale out=$tmpout title=Group");

  rename $tmpout .".sdf", $out .".sdf" 
     or die "Error renaming temp file"; # horrible hack KLUGE
  $Grp->file( $out );

}
