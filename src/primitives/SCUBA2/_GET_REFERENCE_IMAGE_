# -*-perl-*-

=head1 NAME

_GET_REFERENCE_IMAGE_ - Determine the name of a reference image for alignment to a common coordinate frame

=head1 SYNOPSIS

_GET_REFERENCE_IMAGE_ SKYREF=1 COORD_FRAME=ICRS

=head1 DESCRIPTION

This primitive determines the name of a reference image to be used in
aligning images to a common coordinate system. If the B<GROUPREF>
parameter is true, the name of the current Group file is returned if
one exists, else the Group uhdr is queried for the name of a suitable
reference. If neither exists and the user requests alignment in a SKY
frame then a new reference image will be created. In all other cases
the first image in the frame object is chosen as reference.

=head1 ARGUMENTS

The following arguments are supported:

=over 4

=item B<COORD_FRAME>

Celestial frame for reference image. No default but not used if
B<SKYREF> is false.

=item B<GROUP>

A Group object may be speceified rather than using the global Grp for
checking if the Group file exists. A warning is issued if the
parameter is not a member of ORAC::Group class.  The default is the
current Group.

=item B<GROUPREF>

A flag to denote whether to use the Group file as the current
reference if it exists. Default is 1 (yes).

=item B<PIXEL_SCALE>

Pixel scale in arcsec to be used if a new reference image is to be
created. Default is to use the appropriate scale from the calibration
system.

=item B<SKYREF>

A flag to denote whether to align the images to a celestial coordinate
frame. The default is 0 (false) and the images will be aligned with
either the group file if it exists or the first image in the Frame.

=item B<VERBOSE>

A flag to denote whether the primitive should issue verbose
information messages. Default is 0 (false).

=back

=head1 EXTERNAL TASKS

The following external tasks are used:

=over 4

=item KAPPA:

NDFCOPY, WCSATTRIB

=item HDSTOOLS:

HDELETE

=item ORAC-DR PRIMITIVES:

_CREATE_REFERENCE_IMAGE_

=back

=head1 OUTPUT DATA

If a new reference image is created, its name is stored in the Group
uhdr as C<REFIMAGE>.

=head1 OUTPUT FILES

If a new reference image is created, it will have the extension C<_ref>.

=head1 NOTES

To prevent excessive propagation of provenance information when using
the Group file as the reference image, a copy is made and the
provenance in the copy of the Group file is deleted.

=head1 AUTHOR

Andy Gibb E<lt>agg@astro.ubc.caE<gt>

=head1 COPYRIGHT

Copyright (C) 2007-2008 University of British Columbia. All Rights
Reserved.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,
USA.

=cut

# Should I be verbose? (default to no)
my $verbose = get_prim_arg($_PRIM_ARGS_, "VERBOSE", 0);

# Has the user said that it's OK to use the Grp file as reference
# image?  Default to yes.
my $usegrpasref = get_prim_arg($_PRIM_ARGS_, "GROUPREF", 0);

# Has the user specified a pixel scale?
my $pixel_scale = get_prim_arg($_PRIM_ARGS_, "PIXEL_SCALE", $Cal->pixelscale);
# Could this be checked against the pixel scale for an existing
# reference image? What if it's different?

# Do we want to specify an alternative group object?
my $Grpobj;
$Grpobj = get_prim_arg($_PRIM_ARGS_, "GROUP", $Grp);
# Check that the supplied GROUP object is indeed an ORAC-DR group object
unless (UNIVERSAL::isa($Grpobj, "ORAC::Group") ) {
  orac_throw "Error: input GROUP is not an ORAC-DR Grp object\n";
}

my $refimage;
# If there's a Group file, use that
if ($Grpobj->file_exists && $usegrpasref) {
#  $refimage = $Grpobj->file;
  # Temporary HACK - take copy of group image and delete PROVENANCE
  $refimage = new ORAC::TempFile;
  my $in = $Grpobj->file;
  $Mon{ndfpack_mon}->obeyw("ndfcopy","in=$in out=$refimage");
  $Mon{hdstools_mon}->obeyw("hdelete","$refimage.more.provenance");
} elsif ( $Grp->uhdr("REFIMAGE") ) {
  # Or use the current group reference image
  $refimage = $Grp->uhdr("REFIMAGE");
} else {
  # OK so there's no reference image yet. Should we create one in a
  # SKY frame? Default to yes.
  my $skyalign = get_prim_arg($_PRIM_ARGS_, "SKYREF", 1);

  if ( $skyalign && ($Frm->hdr('SAM_MODE') ne "SCAN" ) ) {
    # Output mosaic coordinate frame
    my $cosys_out = lc(get_prim_arg($_PRIM_ARGS_, "COORD_FRAME", ""));
    # If not set, just use the current system
    if ( $cosys_out eq "" ) {
      my $firstfile = $Frm->file(1);
      $Mon{ndfpack_mon}->obeyw("wcsattrib","ndf=$firstfile mode=get name=system(1)");
      (my $ORAC_STATUS, $cosys_out) = $Mon{ndfpack_mon}->get("wcsattrib","value");
    }
    # Set the output coordinate frame
    _CREATE_REFERENCE_IMAGE_ SYSTEM=$cosys_out VERBOSE=1 PIXEL_SCALE=$pixel_scale
    $refimage = $_CREATE_REFERENCE_IMAGE_{REFIMAGE};
  } else {
    # Last resort use the first file in the current Frm
    $refimage = $Frm->file(1);
  }
  $Grp->uhdr("REFIMAGE",$refimage);
}

$_GET_REFERENCE_IMAGE_{REFIMAGE} = $refimage;

