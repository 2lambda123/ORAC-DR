    # Grab some info

    my $outf = $_DITH_COMBINE_{OUT};
    my $outc = $_DITH_COMBINE_{OUTC};

    # If there isn't an output file, then why are you here?

    if (! $outf) {
        orac_throw "_DITH_COMBINE_: No output file specified\n";
    }

    # Get some stats

    foreach my $frm ($Grp->allmembers) {
        my $Frm = $frm;
        _IMSTAT_ CPMLOC=CIR_CPM HDRUP=1
    }
    _ICSCALE_

    # Get some header keywords...

    my $readkey = $Frm->hdrkeys("READNOISE");
    my $gainkey = $Frm->hdrkeys("GAIN");
    my $expkey = $Frm->hdrkeys("EXPOSURE_TIME");

    # Now loop for each of the extensions...

    foreach my $i (1 .. $Frm->findnsubs) {
        my $snum = $Frm->getasubframe($i)->subfrmnumber;

        # Create a temporary file with the input file list in it...

        my $tmpfil = ORAC::TempFile->new;
        my $fh = $tmpfil->handle;
        foreach my $fr ($Grp->allmembers) {
            print $fh $fr->getasubframe($i)->file,"\n";
        }
        $tmpfil->handle->close;

        # Output file and confidence maps...

        my $outfile = sprintf("%s[%d]",$outf,$snum);
        my $outfilec = sprintf("%s[%d]",$outc,$snum);

        # Do the combination

        my $errmsg;
        my $retval = cir_imcombine($tmpfil->file,$outfile,$outfilec,"CIR_CPM",
            MEANCALC,1,1,0,USEWEIGHT,REJPOISSON,1,1,1,4.0,4.0,$readkey,
            $gainkey,$expkey,$errmsg);
        if ($retval != CIR_OK) {
            orac_throw "CIR_IMCOMBINE: failed in _DITH_COMBINE_\n$errmsg\n";
        }

        # Tidy up

        $tmpfil->DESTROY;
    }

=head1 NAME

_DITH_COMBINE_ -- Combine files from a group into a dither

=head1 DESCRIPTION

The images in a group are combined with given offsets to form a dither frame.

=head1 ARGUMENTS

=over 4

=item OUT = char (Given)

Name of the output dither file.

=item OUTC = char (Given)

Name of output dither confidence map

=back

=head1 NOTES

=over 4

=item *

At the moment, things like the rejection algorithm are hard coded. These should
be made into primitive arguments at some stage.

=back

=head1 AUTHORS

JRL: Jim Lewis (CASU, IoA)

=head1 COPYRIGHT

Copyright (C) 2003-2006 Cambridge Astronomy Survey Unit. 
All Rights Reserved

=cut
