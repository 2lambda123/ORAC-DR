# -*-perl-*-

if( $Frm->uhdr( "ORAC_OBSERVATION_TYPE" ) =~ /OBJECT|SKY/ ) {

# Check to see if it's time to do flat-fielding yet.
  if( $Frm->uhdr( "MAKE_FLAT" ) == 1 ) {

# Determine whether or not to mask objects when creating the
# flat-field image.
    my $mask_obj = $_FLAT_FIELD_USTEP_{MASK};
    $mask_obj = defined( $mask_obj ) ? $mask_obj : 1;

# Create the group from the previous N frames.
    my $n_usteps = $Frm->uhdr( "ORAC_NUMBER_OF_MICROSTEP_POSITIONS" );
    if( ! defined( $n_usteps ) ) {
# Should fall back to doing "regular" flat-fielding at this point.
      $n_usteps = 1;
    }

    my @ff_frames = ($Grp->members)[(-$n_usteps)..-1];
    my $ffGrp = new ORAC::Group;
    $ffGrp->push( @ff_frames );

    {
      my $Grp = $ffGrp;

# Make a flat-field image from the group.
      _FLAT_FIELD_MASKED_GROUP_ MASK=$mask_obj

    }

  }

}
