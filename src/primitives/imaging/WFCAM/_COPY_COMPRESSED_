use Astro::FITS::CFITSIO qw(:longnames :constants);

# Create input and output names

my $infile = $Frm->file;
my $outfile = "c" . $infile;

# Check to see if it's already been compressed. Rice compressed data looks like
# a FITS table, so check for that...

my $hdutype;
my $status = 0;
my $fptr = Astro::FITS::CFITSIO::open_file($infile,READONLY,$status);
$fptr->movabs_hdu(2,$hdutype,$status);
$fptr->close_file($status);

# If it's an image then do the compression

if ($hdutype == IMAGE_HDU) {
    my $errmsg;
    my $nread = $Frm->hdr("NEXP");
    $nread = 1 if (! $nread);
    my $retval = cir_compress_mef_f2i($infile,$nread,$outfile,$errmsg);
    if ($retval != CIR_OK) {
        orac_err("CIR_COMPRESS_MEF_F2I: failed in _COPY_COMPRESSED_\n$errmsg\n");
    }
    orac_print("CASU file $infile created\n");
    unlink $infile;
    rename($outfile,$infile);
} else {
    orac_print("$infile is already compressed\n");
}


=head1 NAME

_COPY_COMPRESSED_ -- Make a copy of an input FITS file to a Rice tile
compressed FITS file

=head1 DESCRIPTION

A copy of the current input fits frame is made. This is done with the CFITSIO
Rice tile compression algorithm. The result is written a directory pointed
to by ORAC_DATA_CASU

=head1 ARGUMENTS

None 

=head1 NOTES

The environment variable ORAC_DATA_CASU must be defined and must point to
a directory that can be created and written to.

=head1 AUTHORS

JRL: Jim Lewis (CASU, IoA)

=head1 COPYRIGHT

Copyright (C) 2004-2007 Cambridge Astronomy Survey Unit.
All Rights Reserved

=cut
