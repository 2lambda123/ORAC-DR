#+
# Name:
#    _INSTRUMENT_HELLO_
#
# Purpose:
#    Performs the instrument-specific imaging setup.
#
# Language:
#    Perl5
#
# Description:
#    This primitive is performs the instrument specific setup for
#    imaging.  It's needed for the generic _IMAGING_HELLO_.  In this
#    case it brings the data values in each integration for ND modes
#    into line with other instruments, and are total ADU, not ADU/s.
#    The primitive reports the creation of each corrected integration.
#    It also reports that the set-up operations are complete.
#
#  Notes:
#    -  This primitive is suitable for UIST in imaging mode.
#    -  It accesses the user header ORAC_DETECTOR_READ_TYPE to determine
#    whether or it is an "ND..." read type.
#    -  The exposure time comes from user header ORAC_EXPOSURE_TIME.
#
# Tasks:
#    KAPPA: CMULT.
#
# Output Data:
#    -  For NDSTARE and NDCHOP data, the data are scaled to ADU
#    in a frame inheriting the current frame's name but with the _adu
#    suffix.
#
# Authors:
#    MJC: Malcolm J. Currie (JAC)
#    BC: Brad Cavanagh (JAC)
#
# Copyright:
#    Copyright (C) 1998-2002 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Correct data units to standard
# ==============================

foreach my $i ( 1 .. $Frm->nfiles ) {

  my ( $in, $out ) = $Frm->inout( "_adu", $i );

  my $nreads = ( defined( $Frm->hdr( "MULTIRDS" ) ) ? $Frm->hdr( "MULTIRDS" ) : 1 );

# The exposure time correction only applies to NDSTARE and NDCHOP modes.
  if ( substr( $Frm->uhdr( "ORAC_DETECTOR_READ_TYPE" ), 0, 2 ) eq "ND" ) {

# The data are in ADU/s, which is not the UKIRT standard.  So obtain
# the exposure time and multiply the data by this factor.
    my $exp_time = $Frm->uhdr( "ORAC_EXPOSURE_TIME" );

# Create a temporary file.
    my $tmpfile = new ORAC::TempFile;
    my $tmp = $tmpfile->file;

# Scale the data.
    $Mon{ "kappa_mon" }->obeyw( "cmult", "in=$in scalar=$exp_time out=$tmp" );

# Divide by the number of reads.
    $Mon{ "kappa_mon" }->obeyw( "cdiv", "in=$tmp scalar=$nreads out=$out" );

# Report the processing status.
    orac_print "$in to $out: Scaled data by the exposure time " .
               "($exp_time) to make the units ADUs, and divided " .
               "by the number of reads ($nreads) to get ADUs " .
               "per exposure.\n";

  } else {

# Divide by the number of reads.
    $Mon{ "kappa_mon" }->obeyw( "cdiv", "in=$in scalar=$nreads out=$out" );

# Report the processing status.
    orac_print "$in to $out: Divided by number of reads ($nreads) to get " .
               "ADUs per exposure.\n";

  }

# And update the Frm object.
  $Frm->file( $i, $out );

}

# Report completed processing status for UIST.
orac_print "Global UIST tasks performed.\n\n";

# Podule
# ======

=head1 NAME

_INSTRUMENT_HELLO_ -- Performs the instrument-specific imaging setup.

=head1 DESCRIPTION

This primitive is performs the instrument specific setup for
imaging.  It's needed for the generic L<_IMAGING_HELLO_|_IMAGING_HELLO_>.
In this case it brings the data values in each integration for ND modes
into line with other instruments, and are total ADU, not ADU/s.
The primitive reports the creation of each corrected integration.
It also reports that the set-up operations are complete.

=head1 NOTES

=over 4

=item *

This primitive is suitable for UIST in imaging mode.

=item *

It accesses the user header ORAC_DETECTOR_READ_TYPE to determine
whether or it is an "ND..." read type.

=item *

The exposure time comes from user header ORAC_EXPOSURE_TIME.

=back

=head1 TASKS

KAPPA: CMULT.

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)
BC: Brad Cavanagh (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
