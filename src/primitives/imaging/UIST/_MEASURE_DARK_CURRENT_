=head1 NAME

_MEASURE_DARK_CURRENT_ - returns the dark current for a given frame.

=head1 DESCRIPTION

Returns the dark current for a given frame. This primitive first finds
any bad pixels in the frame using the _FIND_BAD_PIXELS_ primitive, then
masks those bad pixels (along with bad pixels found in a current bad
pixel mask). The dark current is then calculated as the unclipped mean
of the current frame, and is reported in ADU.

=head1 AUTHOR

Brad Cavanagh <b.cavanagh@jach.hawaii.edu>

=head1 COPYRIGHT

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council. All Rights Reserved.

=cut

# Run this primitive if it's time to do so
if ( $Frm->uhdr( "ARRAY_TESTS_MEASURE_DARK_CURRENT" ) ) {

  ( my $in, my $out ) = $Frm->inout( "_at" );

# Calculate the mean
  my ( $mean, $ORAC_STATUS );
  $Mon{ "kappa_mon" }->obeyw( "stats", "ndf=$in" );
  ( $ORAC_STATUS, $mean ) = $Mon{ "kappa_mon" }->get( "stats", "mean" );

# Find the gain
  _GET_GAIN_
  my $gain = $_GET_GAIN_{GAIN};

# Find the exposure time.
  my $exptime = $Frm->uhdr( "ORAC_EXPOSURE_TIME" );
  if( ! defined( $exptime ) ) {
    orac_warn "Exposure time for $Frm->file not defined. Using 60.0 seconds.\n";
    $exptime = 60.0;
  }

# And the dark current in electrons is...
  my $dark = $mean * $gain / $exptime;

# Return the dark current to the user
  orac_print "Dark current is $dark e-/sec.\n\n";

}
