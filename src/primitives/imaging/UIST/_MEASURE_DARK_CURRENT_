=head1 NAME

_MEASURE_DARK_CURRENT_ - measure the dark current for a given frame.

=head1 DESCRIPTION

Measures the dark current for a given frame. The dark current is 
calculated as the unclipped mean of the current frame, and is reported
in ADU.

If this primitive is run at UKIRT, the dark current will be stored
in a logfile at /ukirt_sw/logs/uist_array_tests.log

=head1 AUTHOR

Brad Cavanagh <b.cavanagh@jach.hawaii.edu>

=head1 COPYRIGHT

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council. All Rights Reserved.

=cut

  my $in = $Frm->file;

# Calculate the mean.
  my ( $mean, $ORAC_STATUS );
  $Mon{ "kappa_mon" }->obeyw( "stats", "ndf=$in" );
  ( $ORAC_STATUS, $mean ) = $Mon{ "kappa_mon" }->get( "stats", "mean" );

# Find the gain.
  _GET_GAIN_
  my $gain = $_GET_GAIN_{GAIN};

# Find the exposure time.
  my $exptime = $Frm->uhdr( "ORAC_EXPOSURE_TIME" );
  if( ! defined( $exptime ) ) {
    orac_warn "Exposure time for " . $Frm->file . " not defined. Using 60.0 seconds.\n";
    $exptime = 60.0;
  }

# Calculate the dark current.
  my $dark = $mean * $gain / $exptime;

# Return the dark current to the user, formatted nicely.
  my $o_dark = sprintf( "%9.3f", $dark );
  orac_print "Dark current is $o_dark e-/sec.\n\n";

  # Initially flag the file as not being writable.
  my $writable = 0;
  if( -e "/ukirt_sw/logs" ) {

    # Create a results file if one does not exist.
#    my $results = "/ukirt_sw/logs/uist_array_tests.log";
my $results = "uist_array_tests.log";
    if( -w $results ) {
      $writable = 1;
    }
    if( !( -e $results) ) {
      if( $writable ) {
        open( RESULTS, ">$results" ) ||
          orac_throw "Unable to open a new array-test $results log file. Error: $!.\n";
        orac_print "Creating a new results file called $results\n";

        print RESULTS " UT  Date     Readnoise     Dark Current\n";
        print RESULTS "----------    ---------     ------------\n";
      } else {
        orac_warn "Unable to write to new array-test $results log file.\n";
      }
    } else {
      if( $writable ) {
        open( RESULTS, ">>$results" ) ||
          orac_throw "Unable to append to the array-test $results log file. Error: $!.\n";
      } else {
        orac_warn "Unable to append to the array-test $results log file.\n";
      }
    }
  }

  # Write to the log file.
  if( -e "/ukirt_sw/logs" && $writable ) {
    my $utdate = substr( $Frm->hdr( "DATE-OBS" ), 0, 10 );
    printf RESULTS "%10s                  %16s\n", $utdate, $o_dark;
    close( RESULTS );
  }
