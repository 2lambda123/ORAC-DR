#+
# Name:
#    _INSTRUMENT_HELLO_
#
# Purpose:
#    Performs the instrument-specific imaging setup.
#
# Language:
#    Perl5
#
# Description:
#    This primitive is performs the instrument specific setup for
#    imaging.  It's needed for the generic _IMAGING_HELLO_.  In this
#    case it allows for a missing detector speed gain, and reports
#    that the set-up operations are complete.
#
#  Notes:
#    -  This primitive is suitable for IRCAM.
#    -  It sets the user header ORAC_SPEED_GAIN and adds a card before
#    the DEPERDN keyword to the FITS headers. 
#    -  The gain is "Standard" for a detector bias (from user header
#    ORAC_DETECTOR_BIAS) for a bias of 0.62 volts, or "Deepwell"
#    otherwise.
#
# Tasks:
#    KAPPA: FITSMOD.

# Authors:
#    MJC: Malcolm J. Currie (JAC)
#
# Copyright:
#    Copyright (C) 1998-2002 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Obtain the detecotr bias.
    my $det_bias = $Frm->uhdr( "ORAC_DETECTOR_BIAS" );

# This only needs to be done for old data before 2000 November 22, where
# the SPD_GAIN header was not being written.
    if ( !defined( $Frm->uhdr( "ORAC_SPEED_GAIN" ) ) ) {

# The value depends upon the detector bias, whose two allowed values are
# 0.62 and 0.8V.
       my $spd_gain;
       if ( $det_bias > 0.61 && $det_bias < 0.63 ) {
          $spd_gain = "Standard";
       } else {
          $spd_gain = "Deepwell";
       }

# Set the internal hash for ORAC_SPEED_GAIN.
       $Frm->uhdr( "ORAC_SPEED_GAIN", $spd_gain );
       my %keywords = $Frm->translate_hdr( "ORAC_SPEED_GAIN" );
       my @spdkey = keys( %keywords );

# Correct the FITS header SPD_GAIN value too.
       my $in = $Frm->file;
       my $comment = "Readout speed and gain (Standard|Fast|Deepwell)";
       my $param2 = "comment='$comment' position=DEPERDN";
       my $param1 = "edit=write keyword=$spdkey[ 0 ] value=$spd_gain";
       $Mon{ "ndfpack_mon" }->obeyw( "fitsmod", "ndf=$in $param1 $param2" );

# Report the processing status.
       orac_print "Frame $in has $spdkey[ 0 ] set to $spd_gain.\n";
    }

# Report processing status.
    orac_print "Global IRCAM tasks performed.\n\n";

# Podule
# ======

=head1 NAME

_INSTRUMENT_HELLO_ -- Performs the instrument-specific imaging setup.

=head1 DESCRIPTION

This primitive is performs the instrument specific setup for
imaging.  It's needed for the generic L<_IMAGING_HELLO_|_IMAGING_HELLO_>.
In this case it allows for a missing detector speed gain, and reports
that the set-up operations are complete.

=head1 NOTES

=over 4

=item *

This primitive is suitable for IRCAM.

=item *

It sets the user header ORAC_SPEED_GAIN and adds a card before
the DEPERDN keyword to the FITS headers. 

=item *

The gain is "Standard" for a detector bias (from user header
ORAC_DETECTOR_BIAS) for a bias of 0.62 volts, or "Deepwell"
otherwise.

=back

=head1 AUTHORS

MJC: Malcolm J. Currie (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
