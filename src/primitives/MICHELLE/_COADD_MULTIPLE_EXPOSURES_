# _COADD_MULTIPLE_EXPOSURES_ -*-perl-*-
#
# Primitive to coadd exposures at the same grating position
#
# This should eventually differentiate between multiple frames at
# different positions and chop beams etc.  and could possibly have
# multi frame outputs. In other words, this primitive is going to get
# a lot more complicated than this.

# Note that this serves the additional purpose of turning an HDS
# container into a flat NDF. Therefore it should still be allowed to run
# even if only one frame per exposure is being taken.

# frossie@jach.hawaii.edu


my $nfiles = $Frm->nfiles;

# generate "ia + ib + ic .... " expression for kappa maths
my $exp = join ("+",grep {$_ = "i".chr($_+96)} (1..$nfiles));

# generate "ia=cfoo_1.i1  ib=cfoo_1.i2 ic=cfoo_1.i3 .... " expression for input to kappa maths
my $args =  join (" ",grep {$_ = "i".chr($_+96)."=".$Frm->file($_)} (1..$nfiles));

# generate name of output file
$Frm->files($Frm->file);
my ($in,$out) = $Frm->inout("_co");

$Mon{'kappa_mon'}->obeyw("maths","exp=$exp out=tmp$$ $args");

$Mon{'kappa_mon'}->obeyw("cdiv","in=tmp$$ out=$out scalar=$nfiles");

$Frm->file($out);

$Display->display_data($Frm) if defined $Display;

orac_print ("Frames coadded into $out\n");
