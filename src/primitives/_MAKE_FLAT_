# _MAKE_FLAT_
#
# Forms a flat-field. 
#
# TASK: CCDPACK - MAKEFLAT
#
# This should only be performed on OBJECT frames.
if ($Hdr{OBSTYPE} =~ /OBJECT/) {

# Can generate a flat field and mosaic when there are at least three
# object frames.
   if ($#objects + 1 > 2 ) {

# Form a list of input file names for MAKEFLAT.
      $isuffix = ($_FLAT_FIELD_{SUFFIX_IN} || "_dk");
	@infiles = @objects;
	grep($_.=$isuffix,@infiles);
	$objlist = join(",",@infiles);

# user-accessible mapping and parameters
      $user = "";

# Assign the other parameters.  Note that the dark and output flat are
# hardwired for the moment.
      $osuffix = ($_FLAT_FIELD_{SUFFIX_OUT} || "_fl");
      $header = "in='$objlist' out=${root}flat";
      $hidden = "method=median"; 

# Median filter of the debiassed and dark-corrected object frames to
# produce the flatfield.
      $main::Mon{"ccdpack_red"}->obeyw("makeflat","$header $user $hidden reset accept");
      print "Command was: makeflat $header $user $hidden reset accept\n";

#
      print "Orac says: frames $objlist used to make flat\n";
   };
};
