# _DIVIDE_BY_FLAT_
#
# Divides by a flat-field. 
#
# TASK: CCDPACK - FLATCOR
#
# This should only be performed on OBJECT frames.
if ($Frm->hdr(OBSTYPE) =~ /OBJECT/) {

  # Can generate a flat field and mosaic when there are at least three
  # object frames.
   if ($Grp->num >= 2 ) {

     # user-accessible mapping and parameters
     $user = "";

     # Assign other parameters.  
     $osuffix = ($_FLAT_FIELD_{SUFFIX_OUT} || "_ff");

     # Generate list of input and output filenames
     ($inref, $outref) = $Grp->inout($osuffix);

     # Convert list to comma separated list
     $inlist = join(",", @$inref);
     $outlist= join(",", @$outref);

     $header = "in=\'$inlist\' flat=".$Cal->flat." out=\'$outlist\'";
     $hidden = ""; 

     # Flatfield all the object frames.  Generate output names from the
     # input list, switching fielname suffices.
     $Mon{"ccdpack_red"}->control('par_reset');
     $Mon{"ccdpack_red"}->obeyw("flatcor","$header $user $hidden");
#
     print colored("Orac says: frames $inlist flat-fielded\n",'magenta');


     # Now update the output filenames for each member of the group
     # This is fine until we come round again and find that we are trying
     # to flatfield files that were flatfielded last time
     # It is up to the _MAKE_FLAT_ primitive to work out which files
     # are meant to be used for input here.
     $Grp->membernames(@$outref);

   };
};
