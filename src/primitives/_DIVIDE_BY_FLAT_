# _DIVIDE_BY_FLAT_
#
# Divides by a flat-field. 
#
# TASK: CCDPACK - FLATCOR
#
# This should only be performed on OBJECT frames.
if ($Header{OBSTYPE} =~ /OBJECT/) {

# Can generate a flat field and mosaic when there are at least three
# object frames.
   if ($#objects + 1 > 2 ) {

# user-accessible mapping and parameters
      $user = "";

# Assign other parameters.  Note that the flat is hardwired for the moment.
      $isuffix = ($_FLAT_FIELD_{SUFFIX_IN} || "_dk");
      $osuffix = ($_FLAT_FIELD_{SUFFIX_OUT} || "_fl");
	@infiles = @objects;
	grep($_.=$isuffix,@infiles);
	$objlist = join(",",@infiles);
      $header = "in='$objlist' flat=ro970815_flat out='*|$isuffix|$osuffix|'";
      $hidden = ""; 

# Flatfield all the object frames.  Generate output names from the
# input list, switching fielname suffices.
	print "GOING INTO FLATCOR:\n-$header-\n-$hidden-\n-$user-\n";
	$Orac{"Mon_ccdpack_red"}->control('par_reset');
      $Orac{"Mon_ccdpack_red"}->obeyw("flatcor","$header $user $hidden");
#
      print "Orac says: frames $objlist flat-fielded\n";
   };
};
