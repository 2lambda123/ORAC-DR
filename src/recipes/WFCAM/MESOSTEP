#+
# Name:
#    USTEP_JITTER_FLAT_SKYSUB_J_INCL

# Purpose:
#    Standard processing for tile including interleaving, jittering,
#    flat and sky correction. Sky estimate is from all images in
#    the a current frame's jitter sequence.

# Language:
#    Perl5

# Description:
#    This recipe does the instrumental signature processing on frames and
#    then various combinations. This includes:
#	- Dark correction and flat fielding, both using pre-existing master
#	  frames.
#	- Sky estimation and subtraction. This is done by combining all of the
#	  frames in the current frame's jitter sequence
#	- Interleaving
#       - Dithering
#       - Object extraction and classification
#       - WCS Fitting
#       - Photometric zero point calculation
#	- Filing of DQC information
#	- Display of the final dither frame.
#

# Notes:
#    -  Because we have to wait until all of the frames from the current jitter
#       are available before doing the sky estimate, none of the combinations
#	will be done until that time.
#

# Output Data:
#    -  Interleaved super frames and confidence maps
#    -  Dithered stacked frames and confidence maps.
#    -  All combined frames are astrometrically and photometrically calibrated

# Configurable Steering Parameters:
#    None

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing is all done with CIRDR routines.

# References:
#    None

# Related Recipes:
#    USTEP_JITTER_FLAT_SKYSUB_T_EXCL, USTEP_JITTER_FLAT_SKYSUB_T_INCL,
#    USTEP_JITTER_FLAT_SKYSUB_J_EXCL

# Authors:
#    JRL: Jim Lewis (CASU)
#
# Copyright:
#    Copyright (C) 2004-2007 Cambridge Astronomical Survey Unit.
#    All Rights Reserved.
#
#-

# Get started

_WFCAM_HELLO_

# Decide when we can skysubtract, interleave and dither

_BASIC_JITTER_STEER_

# Add various things to the headers

_FIX_HEADERS_

# Do flat field and dark correction using library master calibration frames

_STAGE1_ FLATCOR=1 DARKCOR=1

_QUAD_BLKMED_

# Form a mean sky frame and subtract it 

my $Frmcpm = $Frm->new($Frm->hdr("CIR_CPM"));
_IMCORE_ IPIX=5 THRESH=1.5 ICROWD=0 RCORE=3.5
_WCSFIT_ PASS=2
_UPDATECAT_
_CLASSIFY_
_SKYPERCENT_IMAGE_
my $filt = $Frm->uhdr("ORAC_FILTER");
_DOPHOTOM_IMAGE_ FILTER=$filt
_PROCHIST_

=head1 NAME

USTEP_JITTER_FLAT_SKYSUB_J_INCL -- Standard processing for tile including 
interleaving, jittering, flat and sky correction. Sky estimate is from all 
images in the current frame's jitter sequence.

=head1 DESCRIPTION

This recipe does the instrumental signature processing on frames and
then various combinations. This includes:

=over 4

=item * 

Dark correction and flat fielding, both using pre-existing master frames.

=item * 

Sky estimation and subtraction. This is done by combining all of the
frames in the current frame's jitter sequence.

=item *

Interleaving

=item *

Dithering

=item *

Object extraction and classification

=item *

WCS Fitting

=item *

Photometric zero point calculation

=item *

Filing of DQC information

=item *

Display of the final dither frame.

=back

=head1 NOTES

=over 4

=item *

Because we have to wait until all of the frames from the current jitter
are available before doing the sky estimate, none of the combinations
will be done until that time.

=back

=head1 OUTPUT DATA

=over 4

=item *

Interleaved super frames and confidence maps

=item *

Dithered stacked frames and confidence maps.

=item *

All combined frames are astrometrically and photometrically calibrated

=back

=head1 CONFIGURABLE STEERING PARAMETERS

None

=head1 IMPLEMENTATION STATUS

=over 4

=item *

All processing is done with CIRDR routines.

=item *

Files are in standard Multi-extension FITS.

=back

=head1 REFERENCES

None

=head1 RELATED RECIPES

L<USTEP_JITTER_FLAT_SKYSUB_T_EXCL|USTEP_JITTER_FLAT_SKYSUB_T_EXCL>
L<USTEP_JITTER_FLAT_SKYSUB_T_INCL|USTEP_JITTER_FLAT_SKYSUB_T_INCL>
L<USTEP_JITTER_FLAT_SKYSUB_J_EXCL|USTEP_JITTER_FLAT_SKYSUB_J_EXCL>

=head1 AUTHORS

Jim Lewis (CASU) (jrl@ast.cam.ac.uk)

=head1 COPYRIGHT

Copyright (C) 2004-2007 Cambridge Astronomical Survey Unit.
All Rights Reserved.

=cut
