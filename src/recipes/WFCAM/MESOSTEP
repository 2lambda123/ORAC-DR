#+
# Name:
#    MESOSTEP

# Purpose:
#    Standard processing for mesostep sequence. This includes dark, 
#    flat and sky correction. Sky estimate is done using quadrant median
#    filtering. A catalogue is generated for each input image

# Language:
#    Perl5

# Description:
#    This recipe does the instrumental signature processing on frames in a 
#    mesostep series.
#	- Dark correction and flat fielding, both using pre-existing master
#	  frames.
#       - Background estimation is done with median filtering of the quadrants.
#       - Object extraction and classification for each input image
#       - WCS Fitting
#       - Photometric zero point calculation
#	- Filing of DQC information
#

# Notes:
#    None
#

# Output Data:
#    -  Individual instrumental signature corrected images and catalogues.

# Configurable Steering Parameters:
#    None

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing is all done with CIRDR routines.

# References:
#    None

# Related Recipes:
#    None

# Authors:
#    JRL: Jim Lewis (CASU)
#

# Copyright:
#    Copyright (C) 2004-2007 Cambridge Astronomical Survey Unit.
#    All Rights Reserved.
#
#-

# Get started

_WFCAM_HELLO_

# Decide when we can skysubtract, interleave and dither

_BASIC_JITTER_STEER_

# Add various things to the headers

_FIX_HEADERS_

# Do flat field and dark correction using library master calibration frames

_STAGE1_ FLATCOR=1 DARKCOR=1

_QUAD_BLKMED_

# Generate a catalogue and fit a WCS 

my $Frmcpm = $Frm->new($Frm->hdr("CIR_CPM"));
_IMCORE_ IPIX=5 THRESH=1.5 ICROWD=0 RCORE=3.5
_WCSFIT_ PASS=2
_UPDATECAT_
_CLASSIFY_

# Do photometry

_SKYPERCENT_IMAGE_
my $filt = $Frm->uhdr("ORAC_FILTER");
_DOPHOTOM_IMAGE_ FILTER=$filt

# Process the header history records

_PROCHIST_

=head1 NAME

MESOSTEP -- Standard processing for mesostep sequence. This includes dark, 
flat and sky correction. Sky estimate is done using quadrant median
filtering. A catalogue is generated for each input image

=head1 DESCRIPTION

This recipe does the instrumental signature processing on frames in a mesostep
series. This includes:

=over 4

=item * 

Dark correction and flat fielding, both using pre-existing master frames.

=item * 

Background estimation is done with median filtering of the quadrants

=item *

Object extraction and classification for each input image

=item *

WCS Fitting

=item *

Photometric zero point calculation

=item *

Filing of DQC information

=item *

Display of the final dither frame.

=back

=head1 NOTES

None

=back

=head1 OUTPUT DATA

=over 4

=item *

Individual instrumental signature corrected images and cataloges

=back

=head1 CONFIGURABLE STEERING PARAMETERS

None

=head1 IMPLEMENTATION STATUS

=over 4

=item *

All processing is done with CIRDR routines.

=item *

Files are in standard Multi-extension FITS.

=back

=head1 REFERENCES

None

=head1 RELATED RECIPES

None

=head1 AUTHORS

Jim Lewis (CASU) (jrl@ast.cam.ac.uk)

=head1 COPYRIGHT

Copyright (C) 2005-2008 Cambridge Astronomical Survey Unit.
All Rights Reserved.

=cut
