#+
# Name:
# MAKE_FLAT
#
# Purpose:
#    Reduces an IFU flat field
#
# Language:
#    Perl5
#
# Description:
#    This recipe takes an IFU flat-field spectrum (probably taken using the
#    UIST Calibration unit grey-body or halogen lamp). It performs bad pixel
#    masking and dark/bias subtraction,
#
#    The locations of the slices and the approximate shifts that should be 
#    applied to them are obtained from calibration files and written into the
#    header of the file by _LOCATE_SLICES_. These are used by _EXTRACT_SLICES_
#    to extract the slices and put them into another 2d image in the correct
#    order (the order in which they cover the 2d field of view) and 
#    approximately aligned in the spectral axis. 
#
#    The frame is now treated as a standard long-slit spectrum. The image is
#    collapsed in the y direction, a polynomial is fitted to this and then
#    grown into an image. This is used to remove the characteristics of the
#    lamp from the flat-field (this does not have to be done precisely because
#    the same flat-field is used for object frames and flux calibrators, so
#    it cancels out anyway). The image is normalised to have a mean value of 1.
#    The flat field is filed with the calibration system.
#
#    Note that an IFU flat field does not look very flat because as well as 
#    removing pixel to pixel variation it also accounts for the difference in
#    transmission from one slice to another. The values in the flat-field can
#    therefore vary significantly from one slice to another.
#
# Authors:
#    Stephen P. Todd (Edinburgh University/UKATC)
#
# Copyright:
#    Copyright (C) 1998-2002 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Switch to spectroscopy mode to use spectroscopy primitives

_UIST_HELLO_

_SPECTROSCOPY_MODE_
_ADD_READNOISE_VARIANCE_
_SUBTRACT_BIAS_
_ADD_POISSON_VARIANCE_
_MASK_BAD_PIXELS_
_IFU_MODE_

_COVER_BAD_ROWS_
_LOCATE_SLICES_
_EXTRACT_SLICES_

_SPECTROSCOPY_MODE_
_NORMALIZE_FLAT_BY_POLY_ 
_FILE_FLAT_
_IFU_MODE_

# Podule
# ======

=head1 Name

MAKE_FLAT -- Reduces an IFU flat field

=head1 Description

This recipe takes an IFU flat-field spectrum (probably taken using the
UIST Calibration unit grey-body or halogen lamp). It performs bad pixel
masking and dark/bias subtraction,

The locations of the slices and the approximate shifts that should be 
applied to them are obtained from calibration files and written into the
header of the file by _LOCATE_SLICES_. These are used by _EXTRACT_SLICES_
to extract the slices and put them into another 2d image in the correct
order (the order in which they cover the 2d field of view) and 
approximately aligned in the spectral axis. 

The frame is now treated as a standard long-slit spectrum. The image is
collapsed in the y direction, a polynomial is fitted to this and then
grown into an image. This is used to remove the characteristics of the
lamp from the flat-field (this does not have to be done precisely because
the same flat-field is used for object frames and flux calibrators, so
it cancels out anyway). The image is normalised to have a mean value of 1.
The flat field is filed with the calibration system.

Note that an IFU flat field does not look very flat because as well as 
removing pixel to pixel variation it also accounts for the difference in
transmission from one slice to another. The values in the flat-field can
therefore vary significantly from one slice to another.

=head1 Authors

Stephen P. Todd (Edinburgh University/UKATC)

=head1 Copyright

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
