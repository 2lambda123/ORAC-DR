# Name:
# MAKE_DATACUBE
#
# Purpose:
#    Reduces a single IFU frame, producing a datacube
#
# Language:
#    Perl5
#
# Description:
#    This recipe takes an IFU arc spectrum. It performs bad pixel masking,
#    dark/bias subtraction, and flat-fielding.
#
#    The locations of the slices and the approximate shifts that should be 
#    applied to them are obtained from calibration files and written into the
#    header of the file by _LOCATE_SLICES_. These are used by _EXTRACT_SLICES_
#    to extract the slices and put them into another 2d image in the correct
#    order (the order in which they cover the 2d field of view) and 
#    approximately aligned in the spectral axis. 
#
#    All the rows of the image are scrunched to a common linear wavelength 
#    scale. The 2d spectrum from each slice is then cut out and used to form
#    a single (y,lambda plane) of the (x, y, lambda) datacube.
#
# Notes:
#    - The variance array should be propagated through the pipeline.
#    - Bad pixels are filled before any resampling to prevent them spreading.
#
# Authors:
#    Stephen P. Todd (Edinburgh University/UKATC)
#
# Copyright:
#    Copyright (C) 1998-2002 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

_UIST_HELLO_

# Switch to spectroscopy mode to use spectroscopy primitives
_SPECTROSCOPY_MODE_
_ADD_READNOISE_VARIANCE_
_ADD_POISSON_VARIANCE_
_SUBTRACT_BIAS_
_MASK_BAD_PIXELS_
_IFU_MODE_

_LOCATE_SLICES_
_EXTRACT_SLICES_

_SPECTROSCOPY_MODE_
_DIVIDE_BY_FLAT_
_IFU_MODE_

_FILL_BAD_PIXELS_
_ISCRUNCH_
_FORM_DATACUBE_

# Podule
# ======

=head1 Name

MAKE_DATACUBE -- Reduces a single IFU frame, producing a datacube

=head1 Description

This recipe takes an IFU arc spectrum. It performs bad pixel masking,
dark/bias subtraction, and flat-fielding.

The locations of the slices and the approximate shifts that should be 
applied to them are obtained from calibration files and written into the
header of the file by _LOCATE_SLICES_. These are used by _EXTRACT_SLICES_
to extract the slices and put them into another 2d image in the correct
order (the order in which they cover the 2d field of view) and 
approximately aligned in the spectral axis. 

All the rows of the image are scrunched to a common linear wavelength 
scale. The 2d spectrum from each slice is then cut out and used to form
a single (y,lambda plane) of the (x, y, lambda) datacube.

=head1 Notes

=over 4

=item *

The variance array should be propagated through the pipeline.

=item *

Bad pixels are filled before any resampling to prevent them spreading.

=back

=head1 Authors

Stephen P. Todd (Edinburgh University/UKATC)

=head1 Copyright

Copyright (C) 1998-2002 Particle Physics and Astronomy Research
Council.  All Rights Reserved.
