# -*-perl-*-

=head1 NAME

REDUCE_POINTING_QL - Recipe for deriving pointing information with Quick Look

=head1 DESCRIPTION

This recipe creates an image from a DREAM/STARE POINTING observation
with the data obtained in Quick-Look mode. 

The images from the individual subarrays are combined, sky emission
removed (assuming a simple DC offset) and extinction is corrected
for. The image is calibrated and a C<.ok> flag file written to allow
the POINTING_FOCUS task at the summit to derive pointing offsets.

For additional record keeping, the source position is fitted and
offsets in Azimuth and Elevation from the nominal (0,0) position are
derived and logged. Note, however, that these may not be identical to
those derived by the POINTING_FOCUS task. Since the pointing will be
measured on a point source, the recipe also determines the beam size
and the flux conversion factor (FCF), which are also written to their
respective log files.

=head1 NOTES 

The pointing offsets, beam size and FCF are written to the log files
C<log.pointing>, C<log.beam> and C<log.fcf>.

This recipe deals with the 2-D DA-processed images, not the time
series data.

The pointing offsets can be calculated from the centroid position or
from a fit to the source: see the C<METHOD> parameter for
_FIND_POINTING_OFFSETS_. The default is to determine the centroid.

=head1 DISPLAY

The Frame image is not displayed.

The Group image is displayed in Gaia window 2; its variance is
displayed in window 3.

=head1 AUTHOR

Andy Gibb E<lt>agg@astro.ubc.caE<gt>,

=head1 COPYRIGHT

Copyright (C) 2008 University of British Columbia. All Rights
Reserved.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,
USA.

=cut

# Standard intro
_SCUBA2_HELLO_

# Set the QUICKLOOK flag
_QUICK_LOOK_STEER_

# For DREAM/STARE QL, the Frame consists of (up to) only 4 (related)
# files collected as DRAMA parameters so there is no need to collate
# related images. Therefore, make the Frame mosaic first so that
# subsequent primitives only have a single file to deal with. This
# results in a noticeable speedup. SCAN QL uses qlmakemap. Use a
# bilinear pixel-spreading scheme to maybe better define the peak
# position.
_CREATE_IMAGE_FRAME_ SPREAD=BILINEAR

# Remove sky, assume it's just a DC offset. This step will be ignored
# for SCAN data as it will have been carried out in qlmakemap.
_REMOVE_DC_SKY_ METHOD=MEAN VERBOSE=0

# Correct for extinction, using a single value across the entire image
# This step will be ignored for SCAN data (see above).
_EXTINCTION_CORRECT_FRAME_ EXTCOR=QUICKER

# Calibrate data using available FCF, though this is not strictly
# necessary
_CALIBRATE_DATA_

# Create Group file - when a new Group file is created, the OBSEND
# flag is set to allow pointing offsets and the beam size to be
# determined.
_MAKE_MOSAIC_GROUP_ COADD_MODE=RUNNING

# Display it
_DISPLAY_GROUP_

# Determine the pointing offsets, use centroid (default).
_FIND_POINTING_OFFSETS_

# Determine beam properties
_FIND_BEAM_SIZE_ GROUP=1

# Delete temporary files, keeping only calibrated files. Note that the
# last file created by the frame will not be deleted because it is
# never replaced by anything so will never get pushed onto the
# intermediates array
_DELETE_TEMP_FILES_ KEEP=_cal
