# QUADRANT_JITTER    -*-perl-*-

=head1 Name:
   QUADRANT_JITTER

=head1 Purpose:
   "Quadrant Jitter" standard reduction including object masking.

=head1 Language:
    perl5

=head1 Description:
    This script reduces a "quadrant jitter" photometry observation
    with UFTI data.  It takes an UFTI observation comprising one or
    more series of four object frames where the target is
    approximately centred in each quadrant; and a dark frame to make
    a calibrated, untrimmed mosaic automatically.

    It performs a null debiassing, bad-pixel masking, dark subtraction,
    flatfield division, feature detection and matching between object
    frames, resampling, and mosaicking.  The resampling comprises
    shifts of origin only.

    The flat field is created iteratively.  First the quadrant
    containing the object is masked in each object frame.  Second an
    approximate flat field is created by combining the normalised
    and masked object frames using the clipped median at each pixel.
    This flat field is applied to the object frames.  Sources within
    the flat-fielded frames are detected, and masked in the
    dark-subtracted frames.  The second stage is repeated but applied
    to the masked frames to create the final flat field.


=head1 References:
    "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 Authors:
    MJC: Malcolm J. Currie (UKATC)

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Recipe-specific initialisation.
    _QUADRANT_JITTER_HELLO_

# Set up steering control of the processing, namely when to make a flat, apply 
# object masking, make a mosaic, and to specify the reference frame for
# normalisation.
    _QUADRANT_JITTER_STEER_

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate the flat field using the quadrant-jitter technique.  Apply
# it.  Mask the sources, and compute a new flat field.  Apply that
# flat field.
    _FLAT_FIELD_QUADRANT_JITTER_

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features.  Register the frames using a shift
# of pixel origin.  Use a lower completeness than normal because each
# set of four has two 50% and two 25% overlaps.
    _GENERATE_OFFSETS_QUADRANT_JITTER_ PERCENTILE=99 COMPLETE=0.4 MINPIX=12

# Resample each frame, and tesselate single-cycle mosaic.  The mosaic is
# untrimmed to the dimensions of an input frame.  Co-add a single-cycle
# mosaic into the main mosaic, which is initially formed using the first
# single-cycle mosaic.
    _MAKE_MOSAIC_QUADRANT_OPTIMISED_

# Remove intermediate data files.
    _DELETE_TEMP_FILES_ KEEP=_ff,_mos

# Remove intermediate data files.
    _DELETE_TEMP_FILES_ KEEP=_ff,_mos

