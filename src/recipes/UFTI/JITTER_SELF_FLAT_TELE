#+
# Name:
#    JITTER_SELF_FLAT_TELE

# Purpose:
#    Reduces a "standard jitter" photometry observation using
#    object masking, and telescope offsets for registration.

# Language:
#    Perl5

# Description:
#    This script reduces a "standard jitter" photometry observation
#    with UFTI data.  It takes an observation comprising jittered
#    object frames and a dark frame to make a calibrated, untrimmed
#    mosaic automatically.

#    It performs a null debiassing, bad-pixel masking, dark
#    subtraction, flat-field creation and division, registration
#    using telescope offsets, and resampling.

#    This recipe works well for faint sources and for moderately
#    crowded fields.  It is also using for observations that track a
#    moving object.

# Notes: 
#    -  A World Co-ordinate System (WCS) using the AIPS convention is 
#    created in the headers should no WCS already exist.
#    -  The bad-pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The flat field is created iteratively.  First an approximate
#    flat-field is created by combining normalised object frames using
#    the median at each pixel.  This flat field is applied to the object
#    frames.  Sources within the flat-fielded frames are detected, and
#    masked in the dark-subtracted frames.  The first stage is repeated
#    but applied to the masked frames to create the final flat field.
#    -  Registration is performed using the telescope offsets
#    transformed to pixels.
#    -  The resampling applies non-integer shifts of origin using
#    bilinear interpolation.  There is no rotation to align the
#    Cartesian axes with the cardinal directions.
#    -  The recipe makes the mosaics by applying offsets in intensity
#    to give the most consistent result amongst the overlapping regions.
#    The mosaic is not trimmed to the dimensions of a single frame, thus
#    the noise will be greater in the peripheral areas having received
#    less exposure time.  The mosaic is not normalised by its exposure
#    time (that being the exposure time of a single frame).
#    -  For each cycle of jittered frames, the recipe creates a mosaic,
#    which has its bad pixels filled and is then added into a master
#    mosaic of improving signal to noise.  The exposure time is also
#    summed and stored in the mosaic's EXP_TIME header.  Likewise the
#    end airmass header, AMEND, is updated to match that of the
#    last-observed frame contributing to the mosaic.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.

# Output Data:
#    -  The integrated mosaic in g<date>_<group_number>_mos.
#    -  A mosaic for each cycle of jittered frames in
#    g<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
#    counts from 0.
#    -  The individual flat-fielded frames in f<date>_<obs_number>_ff.
#    -  The created flat fields in flat_<group_number>subgrp for the
#    first or only cycle, and flat_<group_number>subgrp_<cycle_number>
#    for subsequent cycles.

# Configurable Steering Parameters:
#    NUMBER = INTEGER
#       The number of frames in the jitter pattern.  If not supplied
#       the number of offsets, as given by FITS header NOFFSETS, minus
#       one is used.  If neither is available, 9 is the default.  An
#       error state arises if the number of jittered frames is fewer
#       than 3.  For observations prior to the availability of full
#       ORAC, header NOFFSETS will be absent.  []

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    KAPPA, and PISA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# Related Recipes:
#    JITTER_SELF_FLAT, JITTER_SELF_FLAT_APHOT, JITTER_SELF_FLAT_BASIC, 
#    JITTER_SELF_FLAT_NO_MASK, MOVING_JITTER_SELF_FLAT, QUADRANT_JITTER.

# References:
#   "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

# Authors:
#   MJC: Malcolm J. Currie (UKATC/JAC)

# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Create WCS, if needed.
    _CREATE_WCS_

# Apply recipe-specific setup.
    _JITTER_SELF_FLAT_HELLO_

# Set up steering control of the processing, namely when to make a flat,
# make a mosaic, and to mask objects when making the flat.
    _JITTER_SELF_FLAT_STEER_

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad-pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate an approximate flat field by using the object frames.
# Apply the flat field.  Mask the sources, and compute a new flat field
# using the masked frames.  Finally apply that flat field.
    _FLAT_FIELD_MASKED_GROUP_ MASK=1

# Mosaicking
# ==========

# Register the frames using a shift of origin derived from the
# telescope offsets. 
    _GENERATE_OFFSETS_JITTER_ TELEOFF=1

# Resample each frame, and tesselate.  The mosaic is not trimmed
# to the dimensions of an input frame.
    _MAKE_MOSAIC_NO_BOUND_ RESAMPLE=1 INT_METHOD=linint FILLBAD=1

# Remove intermediate data files.
    _JITTER_SELF_FLAT_TIDY_

# Podule
# ======

=head1 NAME

JITTER_SELF_FLAT_TELE -- Reduces a "standard jitter" photometry observation using object masking,
and telescope offsets for registration.

=head1 DESCRIPTION

This script reduces a "standard jitter" photometry observation
with UFTI data.  It takes an observation comprising jittered
object frames and a dark frame to make a calibrated, untrimmed
mosaic automatically.

It performs a null debiassing, bad-pixel masking, dark
subtraction, flat-field creation and division, registration
using telescope offsets, and resampling.

This recipe works well for faint sources and for moderately
crowded fields.  It is also using for observations that track a
moving object.

=head1 NOTES

=over 4

=item *

A World Co-ordinate System (WCS) using the AIPS convention is 
created in the headers should no WCS already exist.

=item *

The bad-pixel mask applied is F<$ORAC_DATA_CAL/bpm>.

=item *

The flat field is created iteratively.  First an approximate
flat-field is created by combining normalised object frames using
the median at each pixel.  This flat field is applied to the object
frames.  Sources within the flat-fielded frames are detected, and
masked in the dark-subtracted frames.  The first stage is repeated
but applied to the masked frames to create the final flat field.

=item *

Registration is performed using the telescope offsets
transformed to pixels.

=item *

The resampling applies non-integer shifts of origin using
bilinear interpolation.  There is no rotation to align the
Cartesian axes with the cardinal directions.

=item *

The recipe makes the mosaics by applying offsets in intensity
to give the most consistent result amongst the overlapping regions.
The mosaic is not trimmed to the dimensions of a single frame, thus
the noise will be greater in the peripheral areas having received
less exposure time.  The mosaic is not normalised by its exposure
time (that being the exposure time of a single frame).

=item *

For each cycle of jittered frames, the recipe creates a mosaic, which
has its bad pixels filled and is then added into a master mosaic of
improving signal to noise.  The exposure time is also summed and
stored in the mosaic's EXP_TIME header.  Likewise the end airmass
header, AMEND, is updated to match that of the last-observed frame
contributing to the mosaic.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=back

=head1 OUTPUT DATA

=over 4

=item *

The integrated mosaic in gE<lt>dateE<gt>_E<lt>group_numberE<gt>_mos.

=item *

A mosaic for each cycle of jittered frames in
gE<lt>dateE<gt>_E<lt>group_numberE<gt>_mos_E<lt>cycle_numberE<gt>, where E<lt>cycle_numberE<gt>
counts from 0.

=item *

The individual flat-fielded frames in fE<lt>dateE<gt>_E<lt>obs_numberE<gt>_ff.

=item *

The created flat fields in flat_E<lt>group_numberE<gt>subgrp for the
first or only cycle, and flat_E<lt>group_numberE<gt>subgrp_E<lt>cycle_numberE<gt>
for subsequent cycles.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NUMBER = INTEGER

The number of frames in the jitter pattern.  If not supplied
the number of offsets, as given by FITS header NOFFSETS, minus one
is used.  If neither is available, 9 is the default.  An error 
state arises if the number of jittered frames is fewer than 3. 
For observations prior to the availability of full ORAC,
NOFFSETS will be absent.  []

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK
KAPPA, and PISA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 RELATED RECIPES

L<JITTER_SELF_FLAT|JITTER_SELF_FLAT>,
L<JITTER_SELF_FLAT_APHOT|JITTER_SELF_FLAT_APHOT>,
L<JITTER_SELF_FLAT_BASIC|JITTER_SELF_FLAT_BASIC>,
L<JITTER_SELF_FLAT_NO_MASK|JITTER_SELF_FLAT_NO_MASK>,
L<MOVING_JITTER_SELF_FLAT|MOVING_JITTER_SELF_FLAT>,
L<QUADRANT_JITTER|QUADRANT_JITTER>.

=head1 REFERENCES

"I<Scripts for UFTI>" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 AUTHORS

Malcolm J. Currie (UKATC/JAC) (mjc@jach.hawaii.edu)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut 
