+#
# Name:
#    SKY_FLAT

# Purpose:
#    Creates and files a flat field derived from 5 jittered frames.

# Language:
#    Perl5

# Description:
#    This recipe make a sky flat from a series of object frames (these may
#    include blank sky) combined using one of a selection of statistics.
#    It expects one dark frame followed by five object frames.
#
#    It performs a null debiassing, bad-pixel masking, and dark subtraction
#    before combining normalised frames pixel by pixel using the median.
#    Details of the flat is filed in the index of flats for future
#    selection and use of the flat.
#
#    For best results the field observed should contain few stars and no
#    bright ones.  In contaminated sky regions, recipe SKY_FLAT_MASKED will
#    greatly reduce artifacts appearing in the resultant flat.

# Notes:
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  Intermediate frames are deleted.
#    -  Sub-arrays are supported.

# Output Data:
#    -  The flat is called flat_<group_number>.
#    -  The flat is filed in F<$ORAC_DATA_OUT/index.flat>.

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages CCDPACK
#    and KAPPA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through the intermediate file
#    to the flat.
#    -  Error propagation is not used.

# References:
#    "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

# Related Recipes:
#    SKY_FLAT_MASKED.

# Authors:
#    MJC: Malcolm J. Currie (UKATC/JAC)
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Recipe-specific initialisation.
    _SKY_FLAT_HELLO_

# Set up steering control of the processing, namely when to make a flat.
# Here assume that the jitter is 5.  Will make flat at fifth.
    _SKY_FLAT_STEER_ NUMBER=5

# Calibration
# ===========
#
# The following operations are preformed for every appropriate frame.

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Form flat field
# ===============

# This is only done one there are at least three object frames.
    _MAKE_FLAT_FROM_GROUP_

# Remove intermediate data files.
    _SKY_FLAT_TIDY_

# Podule
# ======

=head1 NAME

SKY_FLAT -- Creates and files a flat field derived from 5 jittered frames.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION

This recipe make a sky flat from a series of object frames (these may
include blank sky) combined using one of a selection of statistics.
It expects one dark frame followed by five object frames.

It performs a null debiassing, bad-pixel masking, and dark subtraction
before combining normalised frames pixel by pixel using the median.
Details of the flat is filed in the index of flats for future
selection and use of the flat.

For best results the field observed should contain few stars and no
bright ones.  In contaminated sky regions, recipe SKY_FLAT_MASKED will
greatly reduce artifacts appearing in the resultant flat.

=head1 NOTES

=over 4

=item *

The bad pixel mask applied is F<$ORAC_DATA_CAL/bpm>.

=item *

Intermediate frames are deleted.

=item *

Sub-arrays are supported.

=back

=head1 OUTPUT DATA

=over 4

=item *

The flat is called flat_<group_number>.

=item *

The flat is filed in F<$ORAC_DATA_OUT/index.flat>.

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages CCDPACK
and KAPPA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through the intermediate file
to the dark.

=item *

Error propagation is not used.

=back

=head1 REFERENCES

"I<Scripts for UFTI>" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 RELATED RECIPES

L<SKY_FLAT_MASKED>.

=head1 AUTHORS

Malcolm J. Currie (UKATC/JAC) (mjc@jach.hawaii.edu)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
