#+
# Name:
#    NOD4_SELF_FLAT_NO_MASK_APHOT

# Purpose:
#    Reduces a 4-point "nod jitter" photometry observation,
#    and performs aperture photometry.

# Language:
#    Perl5

# Description:
#    This script reduces a "nod jitter" photometry observation with
#    UFTI data.  It takes an UFTI observation comprising four
#    object frames and a dark frame to make a calibrated, untrimmed
#    mosaic automatically.

#    It performs a null debiassing, bad-pixel masking, dark
#    subtraction, flat-field creation and division, feature
#    detection and matching between object frames, and resampling.

#    Photometry of the point source using a fixed 5-arcsecond aperture
#    is calculated for each jitter frame and the mosaic.  The results
#    appear in $ORAC_DATA_OUT/aphot_results.txt in the form of a Starlink
#    small text list.  The analysis of each star is appended to this file.

#    This recipe works well for faint sources in moderately crowded fields.

# Notes: 
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The flat field is created by combining normalised object 
#    frames using the median at each pixel.
#    -  Registration is performed using common point sources in the
#    overlap regions.  If the recipe cannot identify sufficient common
#    objects, the script resorts to using the telescope offsets
#    transformed to pixels.
#    -  The resampling applies non-integer shifts of origin using
#    bilinear interpolation.  There is no rotation to align the
#    Cartesian axes with the cardinal directions.
#    -  The recipe makes the mosaics by applying offsets in intensity
#    to give the most consistent result amongst the overlapping regions.
#    The mosaic is not trimmed to the dimensions of a single frame, thus
#    the noise will be greater in the peripheral areas having received
#    less exposure time.  The mosaic is not normalised by its exposure
#    time (that being the exposure time of a single frame).
#    -  For each cycle of four, the recipe creates a mosaic, which has
#    its bad pixels filled and is then added into a master mosaic of
#    improving signal to noise.  The exposure time is also summed and
#    stored in the mosaic's EXP_TIME header.  Likewise the end airmass
#    header, AMEND, is updated to match that of the last-observed frame
#    contributing to the mosaic.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.

# Output Data:
#    -  The integrated mosaic in g<date>_<group_number>_mos.
#    -  A mosaic for each cycle of four in
#    g<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
#    counts from 0.
#    -  The individual flat-fielded frames in f<date>_<obs_number>_ff.
#    -  The created flat fields in flat_<group_number>subgrp for the
#    first or only cycle, and flat_<group_number>subgrp_<cycle_number>
#    for subsequent cycles.

# Configurable Steering Parameters:
#    NUMBER = INTEGER
#       The number of frames in the nod pattern.  It must be a multiple
#       of four. [4]

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    KAPPA, and PISA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# Related Recipes:
#    NOD8_SELF_FLAT_NO_MASK_APHOT.

# Authors:
#   MJC: Malcolm J. Currie (JAC)

# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Recipe-specific initialisation.
    _NOD_SELF_FLAT_HELLO_

# Set up steering control of the processing, namely when to difference
# image pairs, when to make a flat, make a mosaic, and to perform
# photometry.
    _NOD_SELF_FLAT_STEER_ NUMBER=4

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad-pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Difference pairs of frames.
    _DIFFERENCE_PAIR_

# Generate the flat field by using the object frames.  There is no
# masking.
    _MAKE_FLAT_FROM_GROUP_

# Apply the flat field to the differenced pairs.
    _DIVIDE_BY_FLAT_NOD_PAIRS_

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features.  If that fails use the telescope
# offsets.  Register the frames using a shift of pixel origin.
    _GENERATE_OFFSETS_NOD_ TELEOFF=1

# Adjust origins of each frame. Make a mosaic which is not trimmed
# to the dimensions of an input frame.
    _MAKE_MOSAIC_NOD_ RESAMPLE=0 FILLBAD=0

# Compute approximate magnitude using aperture photometry for each image,
# both positive and negative.  Use the standard zero point, and extinction
# coefficient for the filter.
    _NOD_APHOT_MAG_

# Remove intermediate data files.
    _NOD_SELF_FLAT_TIDY_

# Podule
# ======

=head1 NAME

NOD4_SELF_FLAT_NO_MASK_APHOT -- Reduces a 4-point "nod jitter" photometry observation, and performs aperture photometry.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION

This script reduces a "nod jitter" photometry observation with
UFTI data.  It takes an UFTI observation comprising four
object frames and a dark frame to make a calibrated, untrimmed
mosaic automatically.

It performs a null debiassing, bad-pixel masking, dark
subtraction, flat-field creation and division, feature
detection and matching between object frames, and resampling.

Photometry of the point source using a fixed 5-arcsecond aperture
is calculated for each jitter frame and the mosaic.  The results
appear in $ORAC_DATA_OUT/aphot_results.txt in the form of a Starlink
small text list.  The analysis of each star is appended to this file.

This recipe works well for faint sources in moderately crowded fields.

=head1 NOTES

=over 4

=item *

The bad pixel mask applied is $ORAC_DATA_CAL/bpm.

=item *

The flat field is created by combining normalised object 
frames using the median at each pixel.

=item *

Registration is performed using common point sources in the
overlap regions.  If the recipe cannot identify sufficient common
objects, the script resorts to using the telescope offsets
transformed to pixels.

=item *

The resampling applies non-integer shifts of origin using
bilinear interpolation.  There is no rotation to align the
Cartesian axes with the cardinal directions.

=item *

The recipe makes the mosaics by applying offsets in intensity
to give the most consistent result amongst the overlapping regions.
The mosaic is not trimmed to the dimensions of a single frame, thus
the noise will be greater in the peripheral areas having received
less exposure time.  The mosaic is not normalised by its exposure
time (that being the exposure time of a single frame).

=item *

For each cycle of four, the recipe creates a mosaic, which has
its bad pixels filled and is then added into a master mosaic of
improving signal to noise.  The exposure time is also summed and
stored in the mosaic's EXP_TIME header.  Likewise the end airmass
header, AMEND, is updated to match that of the last-observed frame
contributing to the mosaic.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=head1 OUTPUT DATA

=over 4

=item *

The integrated mosaic in g<date>_<group_number>_mos.

=item *

A mosaic for each cycle of four in
g<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
counts from 0.

=item *

The individual flat-fielded frames in f<date>_<obs_number>_ff.

=item *

The created flat fields in flat_<group_number>subgrp for the
first or only cycle, and flat_<group_number>subgrp_<cycle_number>
for subsequent cycles.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NUMBER = INTEGER

The number of frames in the nod pattern. It must be a multiple
of four. [4]

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK
KAPPA, and PISA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 RELATED RECIPES

L<NOD8_SELF_FLAT_NO_MASK_APHOT>.

=head1 AUTHORS

Malcolm J. Currie (JAC) (mjc@jach.hawaii.edu)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut 
