# EXTENDED_5x5    -*-perl-*-

=head1 Name:
    EXTENDED_5x5

=head1 Purpose:
    Extended source standard reduction using interpolated sky subtraction.

=head1 Language:
    perl5

=head1 Description: 
    This recipe reduces an extended source using UFTI data.  The data
    comprise alternating blank-sky and target frames commencing and
    ending with a blank sky.  The target frames are arranged in an
    overlapping (30-50%) grid of 5x5 frames from which the recipe
    makes a sky-subtracted untrimmed mosaic automatically.

    The script performs a null debiassing, bad-pixel masking, dark
    subtraction, flat-field division, sky subtraction, registration,
    resampling, and mosaicking.  The notes give more details.

=head1 Notes: 
    The flat field is derived from the sky frames as follows.  The
    mode (sigma-clipped mean) is used to offset each sky frame's mode
    to that of the first sky frame.  The corrected sky frames are
    combined pixel by pixel using a median of the values in each
    frame.  The resultant frame is normalised by its median to form
    the flatfield.  This frame median is subtracted from the source
    frames after they have been flat-fielded.  A flat field is created
    for each row of the grid of target frames, and applied only to
    that row of target frames.

    The sky subtraction comes from linear interpolation of the sky
    modal values of the two sky frames which immediately bracket the
    target frame.

    Registration is performed using common point sources in the
    overlap regions.  If the recipe cannot identify sufficient common
    objects, it then tries the crosshead offsets.  If these are null,
    the script resorts to the telescope offsets.

    The resampling comprises shifts of origin and rotation to align the
    y axis north-south.

    Mosaics are made and displayed for each row, except the last.  At
    the end the full mosaic is created and displayed instead.

=head1 References:
    "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 Authors:
    MJC: Malcolm J. Currie (UKATC)

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Recipe-specific initialisation.
    _EXTENDED_OFFSET_HELLO_

# Set up steering control of the processing.  It classifies which frames
# are target and which are blank sky; specifies when to make a flat, make
# a mosaic of a row, and to create the final mosaic; and which is the
# reference sky frame for normalisation.  It also keeps a count of the
# target frames for interpolation between sky measurements.
    _EXTENDED_STEER_ NROW=5 NCOL=5

# Calibration
# ===========

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate the flat field using the extended-source technique.  This 
# comprises the masking of deviant pixels, and normalisation and
# combination using medians. Also store the reference sky modal value
# and subsequent offsets from it.
    _MAKE_FLAT_EXTENDED_

# Apply the flat field.
    _DIVIDE_BY_FLAT_FROM_EXTENDED_

# Subtract the sky using linear interpolation.
    _SUBTRACT_SKY_EXTENDED_

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features, or if that fails use the offsets
# stored in the headers.  Register the frames using a shift of pixel
# origin.
    _GENERATE_OFFSETS_EXTENDED_

# Apply rotation, resample each frame, and tesselate.  This is either
# the current row, or the final mosaic of all the reduced target frames.
    _MAKE_MOSAIC_EXTENDED_
 
