#+
# Name:
#    EXTENDED_5x5_BASIC

# Purpose:
#    Extended source standard reduction using interpolated sky subtraction.

# Language:
#    Perl5

# Description: 
#    This recipe reduces an extended source using UFTI data.  The data
#    comprise alternating blank-sky and target frames commencing and
#    ending with a blank sky.  The target frames are arranged in an
#    overlapping (30-50%) grid of 5x5 frames from which the recipe
#    makes a sky-subtracted untrimmed mosaic automatically.

#    The script performs bad-pixel masking, null debiassing, dark
#    subtraction, flat-field division, sky subtraction, registration
#    using telescope offsets, and mosaicking.  The notes give more
#    details.

#    It is suitable for extended objects up to 3 arcminutes across.

# Notes: 
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The flat field is derived from the sky frames as follows.  The
#    mode (sigma-clipped mean) is used to offset each sky frame's mode
#    to that of the first sky frame.  The corrected sky frames are
#    combined pixel by pixel using a median of the values in each
#    frame.  The resultant frame is normalised by its median to form
#    the flat field.  This frame median is subtracted from the source
#    frames after they have been flat-fielded.  A flat field is created
#    for each row of the grid of target frames, and applied only to
#    that row of target frames.
#    -  The sky subtraction comes from linear interpolation of the sky
#    modal values of the two sky frames which immediately bracket the
#    target frame.
#    -  Registration is performed using the telescope offsets
#    transformed to pixels.
#    -  There is no resampling, merely integer shifts of origin.
#    -  The recipe makes the mosaics by applying offsets in intensity
#    to give the most consistent result amongst the overlapping regions.
#    -  Mosaics are made and displayed for each row, except the last.  
#    At the end the full mosaic is created and displayed instead.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.

# Output Data:
#    -  The full mosaic in g<date>_<group_number>_mos.
#    -  A mosaic for each row in g<date>_<group_number>_mos<row_number>,
#    where <row_number> is 0 to 3.
#    -  The individual flat-fielded frames in f<date>_<obs_number>_ff.

# Configurable Steering Parameters:
#    NROW = INTEGER
#       The number of target frames in a row of the mosaic.  Its
#       minimum is 3 because this number of blank skies are needed to
#       form a flat field. [5]
#    NCOL = INTEGER
#       The number of target frames in a column of the mosaic.  Its
#       minimum is 2. [5]

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    KAPPA, and PISA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# Related Recipes:
#    QUADRANT_JITTER.

# References:
#    "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

# Authors:
#    MJC: Malcolm J. Currie (UKATC/JAC)

#-

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Recipe-specific initialisation.
    _EXTENDED_HELLO_

# Set up steering control of the processing.  It classifies which frames
# are target and which are blank sky; specifies when to make a flat, make
# a mosaic of a row, and to create the final mosaic; and which is the
# reference sky frame for normalisation.  It also keeps a count of the
# target frames for interpolation between sky measurements.
    _EXTENDED_STEER_ NROW=5 NCOL=5

# Calibration
# ===========

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate the flat field using the extended-source technique.  This 
# comprises the masking of deviant pixels, and normalisation and
# combination using medians. Also store the reference sky modal value
# and subsequent offsets from it.
    _MAKE_FLAT_EXTENDED_

# Apply the flat field.
    _DIVIDE_BY_FLAT_FROM_EXTENDED_

# Subtract the sky using linear interpolation.
    _SUBTRACT_SKY_EXTENDED_

# Mosaicking
# ==========

# Register the frames using a shift of pixel origin determined from the
# telescope offset.
    _GENERATE_OFFSETS_EXTENDED_ TELEOFF=1

# Adjust origins of each frame, and tesselate the mosaic.  This is either
# the current row, or the final mosaic of all the reduced target frames.
    _MAKE_MOSAIC_EXTENDED_ RESAMPLE=0
 
# Remove intermediate data files.
    _EXTENDED_TIDY_

# Podule
# ======

=head1 NAME

EXTENDED_5x5

=head1 PURPOSE

Extended source standard reduction using interpolated sky subtraction.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION 

This recipe reduces an extended source using UFTI data.  The data
comprise alternating blank-sky and target frames commencing and
ending with a blank sky.  The target frames are arranged in an
overlapping (30-50%) grid of 5x5 frames from which the recipe
makes a sky-subtracted untrimmed mosaic automatically.

The script performs bad-pixel masking, null debiassing, dark
subtraction, flat-field division, sky subtraction, registration
using telescope offsets, and mosaicking.  The notes give more
details.

It is suitable for extended objects up to 3 arcminutes across.

=head1 NOTES

=over 4

=item *

The bad pixel mask applied is F<$ORAC_DATA_CAL/bpm>.

=item *

The flat field is derived from the sky frames as follows.  The
mode (sigma-clipped mean) is used to offset each sky frame's mode
to that of the first sky frame.  The corrected sky frames are
combined pixel by pixel using a median of the values in each
frame.  The resultant frame is normalised by its median to form
the flat field.  This frame median is subtracted from the source
frames after they have been flat-fielded.  A flat field is created
for each row of the grid of target frames, and applied only to
that row of target frames.

=item *

The sky subtraction comes from linear interpolation of the sky
modal values of the two sky frames which immediately bracket the
target frame.

=item *

Registration is performed using the telescope offsets
transformed to pixels.

=item *

The resampling applies non-integer shifts of origin using
bilinear interpolation.  There is no rotation to align the
Cartesian axes with the cardinal directions.

=item *

The recipe makes the mosaics by applying offsets in intensity
to give the most consistent result amongst the overlapping regions.

=item *

Mosaics are made and displayed for each row, except the last.  At
the end the full mosaic is created and displayed instead.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=head1 OUTPUT DATA

=over 4

=item *

The resultant mosaic in g<date>_<group_number>_mos.

=item *

A mosaic for each row in g<date>_<group_number>_mos<row_number>,
where <row_number> is 0 to 3.

=item *

The individual flat-fielded frames in f<date>_<obs_number>_ff.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NROW = INTEGER

The number of target frames in a row of the mosaic.  Its
minimum is 3 because this number of blank skies are needed to
form a flat field. [5]

=item NCOL = INTEGER

The number of target frames in a column of the mosaic.  Its
minimum is 2. [5]

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK,
KAPPA, and PISA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 REFERENCES

"I<Scripts for UFTI>" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 Related Recipes:

L<QUADRANT_JITTER>.

=head1 AUTHORS

Malcolm J. Currie (UKATC/JAC)

=cut
