# SKY_FLAT_MASKED    -*-perl-*-
#
# Recipe to make a sky flat from a series of object frames (these may
# include blank sky) combined using one of a selection of statistics.
# It expects one dark frame followed by n object frames.
#
# It performs a null debiassing, bad-pixel masking, and dark subtraction
# before combining normalised frames pixel by pixel using a clipped
# median statistic.  The clipping comprises three rejections at two
# sigma.
#
# The flat field is created iteratively.  First an approximate flat
# field is created by combining normalised object frames using the
# clipped median at each pixel.  This flat field is applied to the
# object frames.  Sources within the flat-fielded frames are
# detected, and masked in the dark-subtracted frames.  The first
# stage is repeated but applied to the masked frames to create the
# final flat field.

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# This gets done for the first frame in sequence
    _SKY_FLAT_HELLO_

# Set up steering control of the processing, namely when to make a flat.
# Here assume that the jitter is 5.  Will make flat at fifth.
    _SKY_FLAT_STEER_ NUMBER=5

# Calibration
# ===========
#
# The following operations are preformed for every appropriate frame.

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Form flat field
# ===============

# Generate an approximate flat field by using the object frames.
# Apply the flat field.  Mask the sources, and compute a new flat field
# using the masked frames.  Finally apply that flat field.
    _FLAT_FIELD_MASKED_GROUP_

# This is only done one there are at least three object frames.
    _MAKE_FLAT_FROM_GROUP_

# Remove intermediate data files.
    _DELETE_TEMP_FILES_ KEEP=_dk,_om
