#+
# Name:
#    SKY_AND_JITTER5

# Purpose:
#    Reduces a 5-point "combined jitter" photometry observation.

# Language:
#    Perl5

# Description:
#    This script reduces a "combined jitter" photometry observation
#    with UFTI data.  It takes an UFTI observation comprising a one or
#    more sets of frames, each set containing a sky frame, followed by
#    five object frames; and a pre-determined flat-field frame to make
#    a calibrated, trimmed mosaic automatically.

#    This recipe performs bad-pixel masking, null debiassing, sky
#    subtraction, flat-field division, feature detection and matching
#    between object frames, and resampling.  See the notes for details.

#    This recipe is suitable for moderately faint point sources.

# Notes:
#    -  You may use SKY_FLAT or SKY_FLAT_MASKED to make the flat field.
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The most-recent sky frame is used for the sky subtraction. 
#    -  Where automatic registration is not possible, the recipe matches
#    the centroid of central source, and should that fail, it resorts
#    to using the telescope offsets transformed to pixels.
#    -  The resampling applies non-integer shifts of origin using
#    bilinear interpolation.  There is no rotation to align the
#    Cartesian axes with the cardinal directions.
#    -  The recipe makes the mosaic by applying offsets in intensity to
#    give the most consistent result amongst the overlapping regions.
#    The mosaic is trimmed to the dimensions of an input frame.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.
#    -  Sub-arrays are supported.

# Output Data:
#    -  The resultant mosaic in g<date>_<group_number>_mos.
#    -  The individual flat-fielded frames in f<date>_<obs_number>_ff.

# Configurable Steering Parameters:
#    NUMBER = INTEGER
#       The number of frames in the jitter pattern. [5]

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    and KAPPA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# References:
#    "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

# Related Recipes:
#    SKY_AND_JITTER5_APHOT, SKY_FLAT, SKY_FLAT_MASKED.

# Authors:
#    MJC: Malcolm J. Currie (UKATC/JAC)
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _UFTI_HELLO_

# Initialisation for the recipe.
    _SKY_AND_JITTER_HELLO_

# Set up steering control of the processing, namely when to file and subtract
# a sky, and when to make a mosaic.
    _SKY_AND_JITTER_STEER_ NUMBER=5

# Calibration
# ===========
#
# The following operations are preformed for every appropriate frame.

# Apply the bad pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# File the first frame and every sixth frame thereafter as a blank-sky
# calibration.
    _FILE_SKY_SKY_AND_JITTER_

# Subtract the sky frame.
    _SUBTRACT_SKY_SKY_AND_JITTER_

# Flat field using a pre-existing calibration frame.
    _DIVIDE_BY_FLAT_

# Make mosaic
# ===========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features.  Register the frames using a shift
# of pixel origin.
    _GENERATE_OFFSETS_SKY_AND_JITTER_

# Apply rotation, resample each frame, and tesselate.  The mosaic is
# trimmed to the dimensions of an input frame.
    _MAKE_MOSAIC_SKY_AND_JITTER_

# Remove intermediate data files.
    _SKY_AND_JITTER_TIDY_

# Podule
# ======

=head1 NAME

SKY_AND_JITTER5

=head1 PURPOSE

Reduces a 5-point "combined jitter" photometry observation.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION

This script reduces a "combined jitter" photometry observation
with UFTI data.  It takes an UFTI observation comprising a one or
more sets of frames, each set containing a sky frame, followed by
five object frames; and a pre-determined flat-field frame to make
a calibrated, trimmed mosaic automatically.

This recipe performs bad-pixel masking, null debiassing, sky
subtraction, flat-field division, feature detection and matching
between object frames, and resampling.  See the notes for details.

This recipe is suitable for moderately faint point sources.

=head1 NOTES

=over 4

=item * 

You may use L<SKY_FLAT> or L<SKY_FLAT_MASKED> to make the flat field.

=item *

The bad pixel mask applied is F<$ORAC_DATA_CAL/bpm>.

=item *

The most-recent sky frame is used for the sky subtraction. 

=item * 

Where automatic registration is not possible, the recipe matches
the centroid of central source, and should that fail, it resorts
to using the telescope offsets transformed to pixels.

=item *

The resampling applies non-integer shifts of origin using
bilinear interpolation.  There is no rotation to align the
Cartesian axes with the cardinal directions.

=item * 

The recipe makes the mosaic by applying offsets in intensity to
give the most consistent result amongst the overlapping regions.
The mosaic is trimmed to the dimensions of an input frame.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=item *

Sub-arrays are supported.

=back

=head1 OUTPUT DATA

=over 4

=item *

The resultant mosaic in g<date>_<group_number>_mos.

=item *

The individual flat-fielded frames in f<date>_<obs_number>_ff.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NUMBER = INTEGER

The number of frames in the jitter pattern. [5]

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK
and KAPPA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 REFERENCES

"I<Scripts for UFTI>" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 RELATED RECIPES

L<SKY_AND_JITTER5_APHOT>, L<SKY_FLAT>, L<SKY_FLAT_MASKED>.

=head1 AUTHORS

Malcolm J. Currie (UKATC/JAC)
