# -*-cperl-*-

=head1 NAME

SCUBA2_FCFNEFD - Recipe for calculating fluxes and noise levels for SCUBA-2 images

=head1 DESCRIPTION

A simple PICARD recipe to calculate fluxes, FCFs and NEFDs from a
given source. The results are written to a log file called
C<log.fcfnefd> if desired.

The FCF calculation requires uncalibrated data and thus must be
performed first. However, note that the NEFD calculation must be
carried out using the (calibrated) original input data.

By default this recipe only works on known calibration
sources. However, the user may specify the source flux at 850 and/or
450 um by using recipe parameters called C<FLUX_850> and C<FLUX_450>
respectively.

If the user specifies the B<LOGFILE> parameter, then the primitives
will collate data for each input file (including results of
calculations) into a hash indexed by the relevant keywords. The hash
for each files is stored in an array reference in the Frame uhdr entry
C<PICARD_RESULTS>. The order of elements in the array matches that for
the input files. See L<_GET_CURRENT_RESULTS_|_GET_CURRENT_RESULTS_>
and the primitives below for examples of the data stored. These
results are then written to a log file on completion of the recipe.

=head1 AVAILABLE PARAMETERS

The following parameters can be set via the -recpar option:

=over 4

=item APERTURE_RADIUS

Radius of aperture in arcsec for calculating total flux.

=item FLUX_450

Source flux density at 450 um in Jy.

=item FLUX_850

Source flux density at 850 um in Jy.

=item LOGFILE

Flag to denote whether to collect data to write to a log file at the
end of processing.

=back

=head1 NOTES

The input data must be uncalibrated in order to calculate an FCF from
calibrator observations.

The results of the FCF and NEFD calculation are printed to the screen
and written to log files, C<log.fcf> and C<log.nefd>.

If run on non-calibrator data, the user should ensure that data from
only one source is used as the recipe uses the same (user-specified)
flux for all non-calibrator sources.

=head1 DISPLAY

No display is used by this recipe.

=head1 AUTHOR

Andy Gibb E<lt>agg@astro.ubc.caE<gt>

=head1 COPYRIGHT

Copyright (C) 2009-2010 University of British Columbia. All Rights
Reserved.

This program is free software; you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation; either version 3 of the License, or (at
your option) any later version.

This program is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307,
USA.

=cut

# Standard SCUBA2 setup
_SCUBA2_SETUP_

# Trim images to map size before removing background to limit bias of
# noisy outer regions
_CROP_IMAGES_

# Remove background - mask out source using 1-arcmin aperture. Use the
# recipe parameters BACKGROUND_MASK and APERTURE_RADIUS to change
# these values. Maps with multiple sources do better with MASK=0
# (which uses findback).
_REMOVE_BACKGROUND_FROM_IMAGE_ FORCE=1 VERBOSE=0 MASK=1 RADIUS=30

# Calculate FCFs
_CALC_SCUBA2_FCF_

# Calculate flux and image-plane noise via aperture photometry
_CALC_FLUX_

# Calculate NEFD for input files - tell the primitive to use the
# original files as the procesing in the previous primitives will have
# generated new files which can not be used for NEFD calculations.
_CALC_SCUBA2_NEFD_ RAW=1

# Determine noise level and mean exposure time for images
_CALC_NOISE_TEXP_

# Write a logfile with the relevant info
_WRITE_FCFNEFD_LOGFILE_
