# JITTER_SELF_FLAT -*-perl-*-

=head1  Name:
     JITTER_SELF_FLAT

=head1  Purpose:
     Reduces a 9-point "standard jitter" photometry observation using
     object masking.     

=head1  Language:
     perl5

=head1  Description:
     This script reduces a "standard jitter" photometry observation
     with IRCAM3 data.  It takes an IRCAM observation comprising nine
     object frames and a dark frame to make a calibrated, untrimmed
     mosaic automatically.

     It performs a null debiassing, bad-pixel masking, dark
     subtraction, flatfield creation, flatfield division, feature
     detection and matching between object frames, resampling, and
     mosaicking.

     The flat field is created iteratively.  First an approximate flat
     field is created by combining normalised object frames using the
     clipped median at each pixel.  This flat field is applied to the
     object frames. Sources within the flat-fielded frames are
     detected, and masked in the dark-subtracted frames.  The first
     stage is repeated but applied to the masked frames to create the
     final flat field.

     The resampling comprises shifts of origin and rotation to align
     the y axis north-south.  The mosaic is not restricted to the bounds
     of the central frame of the jitter.

# Startup
# =======
#
# Every recipe must do this.
    _IRCAM_HELLO_

# This gets done for the first frame in sequence.
    _JITTER_SELF_FLAT_HELLO_

# Set up steering control of the processing, namely when to make a flat,
# make a mosaic, and to mask objects when making the flat.
    _JITTER_SELF_FLAT_STEER_ NUMBER=9

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad-pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate an approximate flat field by using the object frames.
# Apply the flat field.  Mask the sources, and compute a new flat field
# using the masked frames.  Finally apply that flat field.
    _FLAT_FIELD_MASKED_GROUP_

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features.  Register the frames using a shift
# of pixel origin.
    _GENERATE_OFFSETS_

# Apply rotation, resample each frame, and tesselate.  The mosaic is
# not trimmed to the dimensions of an input frame.
    _MAKE_MOSAIC_NO_BOUND_
