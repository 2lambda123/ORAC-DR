#+
# Name:
#    NIGHT_LOG

# Purpose:
#    Produces a text file log of a night's observations.

# Language:
#    Perl5

# Description:
#    This recipe takes a night's observations, and creates a text file
#    containing a headed tabulation of parameters for each frame. 
#
#    The parameters are: observation number, object name, observation type,
#    UT start time, exposure time, number of coadds, read mode and speed,
#    filter, start airmass, frame dimensions in pixels, base equatorial
#    co-ordinates, and data-reduction recipe name.
# 
# Notes:
#    -  Run with "oracdr -noeng -from 1 -skip"  for efficiency.
#    -  The <date> comes from the header keyword IDATE. 
#    -  Specification provided by Sandy Leggett.

# Output Data:
#    -  The text log file $ORAC_DATA_IN/<date>.nightlog, where
#    <date> is the UT date.

# Authors:
#   FE: Frossie Economou (JAC)
#   MJC: Malcolm J. Currie (JAC)

# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Obtain the frame number and UT date.
    my $obsnum = $Frm->number;
    my $obsdate = $Frm->hdr( "IDATE" );

# Test whewther or not this is the first observation.
    if ( $obsnum == 1 ) {

# Specify the nightly log file.
# This is temporary because of a DATE bug in UFTI.
#       my $nightlog = $ENV{'ORAC_DATA_IN'}."/nightlog";
       my $nightlog = $ENV{ "ORAC_DATA_IN" } . "/${obsdate}.nightlog";

       orac_print "Orac says: Log written to $nightlog\n";

# Open a new logfile, clobbering an existing one.
       open( NIGHTLOG, ">$nightlog" );

# Print the header.
       print NIGHTLOG "   Obs       Object      Obstype  UT start     Exp. Nexp   Mode  DetBias   Filter  Airmass  Cols x Rows    RA       DEC    Eqnx DR Recipe\n";
       print NIGHTLOG "-------------------------------------------------------------------------------------------------------------------------------------------------------------\n";
       close NIGHTLOG;

# Open file for append from subsequent frames.
       open( NIGHTLOG, ">>$nightlog" );
    }

# Define the Perl format for each entry in the log.
    my $format = "%5d %16s %8s %10.6f %8.2f %3d %8s %7.2f %8s %8.5f %4d x %4d %9.5f %+9.5f %4d %-16s\n";

# Write the record using the prescribed format.
    printf NIGHTLOG $format,
                    $obsnum,
                    $Frm->hdr( "OBJECT" ),
                    $Frm->hdr( "OBSTYPE" ),
                    $Frm->hdr( "RUTSTART" ),
                    $Frm->hdr( "DEXPTIME" ),
                    $Frm->hdr( "NEXP" ),
                    $Frm->hdr( "MODE" ),
                    $Frm->hdr( "DET_BIAS" ),
                    $Frm->hdr( "FILTER" ),
                    $Frm->hdr( "AMSTART" ),
                    $Frm->hdr( "RDOUT_X2" ) - $Frm->hdr( "RDOUT_X1" ) + 1,
                    $Frm->hdr( "RDOUT_Y2" ) - $Frm->hdr( "RDOUT_Y1" ) + 1,
                    $Frm->hdr( "RABASE" ),
                    $Frm->hdr( "DECBASE" ),
                    $Frm->hdr( "EQUINOX" ),
                    $Frm->hdr( "DRRECIPE" );

# Podule
# ======

=head1 NAME

NIGHT_LOG -- Produces a text file log of a night's observations.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION

This recipe takes a night's observations, and creates a text file
containing a headed tabulation of parameters for each frame. 

The parameters are: observation number, object name, observation type,
UT start time, exposure time, number of coadds, read mode and speed,
filter, start airmass, frame dimensions in pixels, base equatorial
co-ordinates, and data-reduction recipe name.

=head1 NOTES

=over 4

=item *

Run with "oracdr -noeng -from 1 -skip"  for efficiency.

=item *

The <date> comes from the header keyword DATE. 

=item *

Specification provided by Sandy Leggett.

=back 4

=head1 OUTPUT DATA

=over 4

=item *

The text log file $ORAC_DATA_IN/<date>.nightlog, where
<date> is the UT date.

=head1 AUTHORS

Frossie Economou (JAC), Malcolm J. Currie (JAC)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut
