#+
# Name:
#    NOD8_SELF_FLAT_NO_MASK

# Purpose:
#    Reduces a 8-point "nod jitter" observation.

# Language:
#    Perl5

# Description:
#    This script reduces a "nod jitter" observation with IRCAM/TUFTI data.
#    It takes a TUFTI observation comprising eight object frames and a
#    dark frame to make a calibrated, untrimmed  mosaic automatically.

#    It performs a null debiassing, bad-pixel masking, dark
#    subtraction, flat-field creation and division, feature
#    detection and matching between object frames, and resampling.

#    This recipe works well for faint sources in moderately crowded fields.

# Notes: 
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The flat field is created by combining normalised object 
#    frames using the median at each pixel.
#    -  Registration is performed using common point sources in the
#    overlap regions.  If the recipe cannot identify sufficient common
#    objects, the script resorts to using the telescope offsets
#    transformed to pixels.
#    -  The resampling applies non-integer shifts of origin using
#    bilinear interpolation.  There is no rotation to align the
#    Cartesian axes with the cardinal directions.
#    -  The recipe makes the mosaics by applying offsets in intensity
#    to give the most consistent result amongst the overlapping regions.
#    The mosaic is not trimmed to the dimensions of a single frame, thus
#    the noise will be greater in the peripheral areas having received
#    less exposure time.
#    -  For each cycle of eight, the recipe creates a mosaic, which has
#    its bad pixels filled and is then co-added into a master mosaic of
#    improving signal to noise.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.

# Output Data:
#    -  The integrated mosaic in rg<date>_<group_number>_mos.
#    -  A mosaic for each cycle of eight in
#    rg<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
#    counts from 0.
#    -  The individual flat-fielded frames in ro<date>_<obs_number>_ff.
#    -  The created flat fields in flat_<group_number>subgrp for the
#    first or only cycle, and flat_<group_number>subgrp_<cycle_number>
#    for subsequent cycles.

# Configurable Steering Parameters:
#    NUMBER = INTEGER
#       The number of frames in the nod pattern.  It must be a multiple
#       of four. [8]

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    KAPPA, and PISA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# Related Recipes:
#    NOD4_SELF_FLAT_NO_MASK_APHOT, NOD4_SELF_FLAT_NO_MASK, 
#    NOD8_SELF_FLAT_NO_MASK_APHOT.

# Authors:
#   MJC: Malcolm J. Currie (JAC)

# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _IRCAM_HELLO_

# Recipe-specific initialisation.
    _NOD_SELF_FLAT_HELLO_

# Set up steering control of the processing, namely when to difference
# image pairs, when to make a flat, make a mosaic, and to perform
# photometry.
    _NOD_SELF_FLAT_STEER_ NUMBER=8

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad-pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Difference pairs of frames.
    _DIFFERENCE_PAIR_

# Generate the flat field by using the object frames.  There is no
# masking.
    _MAKE_FLAT_FROM_GROUP_

# Apply the flat field to the differenced pairs.
    _DIVIDE_BY_FLAT_NOD_PAIRS_

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# by pattern matching common features.  If that fails use the telescope
# offsets.  Register the frames using a shift of pixel origin.
    _GENERATE_OFFSETS_NOD_ TELEOFF=1

# Adjust origins of each frame. Make a mosaic which is not trimmed
# to the dimensions of an input frame.
    _MAKE_MOSAIC_NOD_ RESAMPLE=0 FILLBAD=0

# Remove intermediate data files.
    _NOD_SELF_FLAT_TIDY_

# Podule
# ======

=head1 NAME

NOD8_SELF_FLAT_NO_MASK -- Reduces a 8-point "nod jitter" observation.

=head1 DESCRIPTION

This script reduces a "nod jitter" observation with IRCAM/TUFTI data.
It takes an TUFTI observation comprising eight object frames and a
dark frame to make a calibrated, untrimmed mosaic automatically.

It performs a null debiassing, bad-pixel masking, dark
subtraction, flat-field creation and division, feature
detection and matching between object frames, and resampling.

This recipe works well for faint sources in moderately crowded fields.

=head1 NOTES

=over 4

=item *

The bad pixel mask applied is F<$ORAC_DATA_CAL/bpm>.

=item *

The flat field is created by combining normalised object 
frames using the median at each pixel.

=item *

Registration is performed using common point sources in the
overlap regions.  If the recipe cannot identify sufficient common
objects, the script resorts to using the telescope offsets
transformed to pixels.

=item *

The resampling applies non-integer shifts of origin using
bilinear interpolation.  There is no rotation to align the
Cartesian axes with the cardinal directions.

=item *

The recipe makes the mosaics by applying offsets in intensity
to give the most consistent result amongst the overlapping regions.
The mosaic is not trimmed to the dimensions of a single frame, thus
the noise will be greater in the peripheral areas having received
less exposure time.

=item *

For each cycle of eight, the recipe creates a mosaic, which has
its bad pixels filled and is then co-added into a master mosaic of
improving signal to noise.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=back

=head1 OUTPUT DATA

=over 4

=item *

The integrated mosaic in rgE<lt>dateE<gt>_E<lt>group_numberE<gt>_mos.

=item *

A mosaic for each cycle of eight in
rgE<lt>dateE<gt>_E<lt>group_numberE<gt>_mosE<lt>cycle_numberE<gt>,
where E<lt>cycle_numberE<gt> counts from 0.

=item *

The individual flat-fielded frames in roE<lt>dateE<gt>_E<lt>obs_numberE<gt>_ff.

=item *

The created flat fields in flat_E<lt>group_numberE<gt>subgrp for the
first or only cycle, and flat_E<lt>group_numberE<gt>subgrp_E<lt>cycle_numberE<gt>
for subsequent cycles.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NUMBER = INTEGER

The number of frames in the nod pattern. It must be a multiple
of four. [8]

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK
KAPPA, and PISA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 RELATED RECIPES

L<NOD4_SELF_FLAT_NO_MASK|NOD4_SELF_FLAT_NO_MASK>,
L<NOD4_SELF_FLAT_NO_MASK_APHOT|NOD4_SELF_FLAT_NO_MASK_APHOT>,
L<NOD8_SELF_FLAT_NO_MASK_APHOT|NOD8_SELF_FLAT_NO_MASK_APHOT>.

=head1 AUTHORS

Malcolm J. Currie (JAC) (mjc@jach.hawaii.edu)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut 
