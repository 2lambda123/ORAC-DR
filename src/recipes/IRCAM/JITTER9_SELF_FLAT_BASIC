#+
# Name:
#    JITTER9_SELF_FLAT_BASIC

# Purpose:
#    Reduces a 9-point "standard jitter" photometry observation using
#    just the basic operations for speed.

# Language:
#    Perl5

# Description:
#    This script reduces a "standard jitter" photometry observation
#    with IRCAM data.  It takes an IRCAM observation comprising nine
#    object frames and a dark frame to make a calibrated, untrimmed
#    mosaic automatically.

#    It performs a null debiassing, bad-pixel masking, dark
#    subtraction, flat-field creation, flat-field division, integer
#    shifts of origin to register, and mosaicking.

#    This recipe aims to keep pace with the pipeline's incoming
#    data, and is intended for faint sources and for moderately
#    crowded fields.

# Notes:
#    -  The bad pixel mask applied is $ORAC_DATA_CAL/bpm.
#    -  The flat field is created by combining normalised object 
#    frames using the clipped median at each pixel.
#    -  Registration is performed using the telescope offsets
#    transformed to pixels.
#    -  There is no resampling, merely integer shifts of origin.
#    -  The recipe makes the mosaics by applying offsets in intensity
#    to give the most consistent result amongst the overlapping regions.
#    The mosaic is not trimmed to the dimensions of a single frame, thus
#    the noise will be greater in the peripheral areas having received
#    less exposure time.  The mosaic is not normalised by its exposure
#    time (that being the exposure time of a single frame).
#    -  For each cycle of nine, the recipe creates a mosaic, which is
#    then added into a master mosaic of improving signal to noise.  The
#    exposure time is also summed and stored in the mosaic's EXP_TIME
#    header.  Likewise the end airmass header, AMEND, is updated to match
#    that of the last-observed frame contributing to the mosaic.
#    -  Intermediate frames are deleted except for the flat-fielded (_ff
#    suffix) frames.

# Output Data:
#    -  The integrated mosaic in rg<date>_<group_number>_mos.
#    -  A mosaic for each cycle of four in
#    rg<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
#    counts from 0.
#    -  The individual flat-fielded frames in ro<date>_<obs_number>_ff.
#    -  The created flat fields in flat_<group_number>subgrp for the
#    first or only cycle, and flat_<group_number>subgrp_<cycle_number>
#    for subsequent cycles.

# Configurable Steering Parameters:
#    NUMBER = INTEGER
#       The number of frames in the jitter pattern. [9]

# Timing:
#    {timing_information}

# Implementation Status:
#    -  The processing engines are from the Starlink packages: CCDPACK
#    KAPPA, and PISA.
#    -  Uses the Starlink NDF format.
#    -  History is recorded within the data files.
#    -  The title of the data is propagated through intermediate files
#    to the mosaic.
#    -  Error propagation is not used.

# Related Recipes:
#    JITTER5_SELF_FLAT, JITTER5_SELF_FLAT_NO_MASK, JITTER5_SELF_FLAT_APHOT,
#    JITTER9_SELF_FLAT, JITTER9_SELF_FLAT_NO_MASK, QUADRANT_JITTER,
#    QUADRANT_JITTER_NO_MASK.

# References:
#   "Scripts for UFTI" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

# Authors:
#   MJC: Malcolm J. Currie (UKATC/JAC)

# Copyright:
#    Copyright (C) 1998-2000 Particle Physics and Astronomy Research
#    Council.  All Rights Reserved.
#
#-

# Startup
# =======
#
# Every recipe must do this.
    _IRCAM_HELLO_

# This gets done for the first frame in sequence.
    _JITTER_SELF_FLAT_HELLO_

# Set up steering control of the processing, namely when to make a flat,
# make a mosaic, and to mask objects when making the flat.
    _JITTER_SELF_FLAT_STEER_ NUMBER=9

# Calibration
# ===========
#
# The following operations are performed for every appropriate frame.

# Apply the bad-pixel mask.
    _MASK_BAD_PIXELS_

# Remove the bias.
    _REMOVE_BIAS_

# Subtract the dark frame.
    _SUBTRACT_DARK_

# Generate an approximate flat field by using the object frames.
# Apply the flat field.   No object masking is applied.
    _FLAT_FIELD_MASKED_GROUP_ MASK=0

# Mosaicking
# ==========

# Determine the linear offsets between the object frames in the group
# from the telescope offsets.  Register the frames using a shift
# of pixel origin.
    _GENERATE_OFFSETS_JITTER_ TELEOFF=1

# Apply shifts of origin, and tesselate.  The mosaic is not trimmed to
# the dimensions of an input frame.  Bad pixels are not filled.
    _MAKE_MOSAIC_NO_BOUND_ RESAMPLE=0 FILLBAD=0

# Remove intermediate data files.
    _JITTER_SELF_FLAT_TIDY_

# Podule
# ======

=head1 NAME

JITTER9_SELF_FLAT_BASIC -- Reduces a 9-point "standard jitter" photometry observation using object masking.

=head1 LANGUAGE

Perl5

=head1 DESCRIPTION

This script reduces a "standard jitter" photometry observation
with IRCAM data.  It takes an IRCAM observation comprising nine
object frames and a dark frame to make a calibrated, untrimmed
mosaic automatically.

It performs a null debiassing, bad-pixel masking, dark
subtraction, flatfield creation, flatfield division, integer
shifts of origin to register, and mosaicking.

This recipe aims to keep pace with the pipeline's incoming
data, and is intended for faint sources and for moderately
crowded fields.

=head1 NOTES

=over 4

=item *

The bad pixel mask applied is $ORAC_DATA_CAL/bpm.

=item *

The flat field is created by combining normalised object 
frames using the clipped median at each pixel.

=item *

Registration is performed using the telescope offsets
transformed to pixels.

=item *

There is no resampling, merely integer shifts of origin.

=item *

The recipe makes the mosaics by applying offsets in intensity
to give the most consistent result amongst the overlapping regions.
The mosaic is not trimmed to the dimensions of a single frame, thus
the noise will be greater in the peripheral areas having received
less exposure time.  The mosaic is not normalised by its exposure
time (that being the exposure time of a single frame).

=item *

For each cycle of nine, the recipe creates a mosaic, which is
then added into a master mosaic of improving signal to noise.  The
exposure time is also summed and stored in the mosaic's EXP_TIME
header.  Likewise the end airmass header, AMEND, is updated to match
that of the last-observed frame contributing to the mosaic.

=item *

Intermediate frames are deleted except for the flat-fielded (_ff
suffix) frames.

=head1 OUTPUT DATA

=over 4

=item *

The integrated mosaic in rg<date>_<group_number>_mos.

=item *

A mosaic for each cycle of four in
rg<date>_<group_number>_mos_<cycle_number>, where <cycle_number>
counts from 0.

=item *

The individual flat-fielded frames in ro<date>_<obs_number>_ff.

=item *

The created flat fields in flat_<group_number>subgrp for the
first or only cycle, and flat_<group_number>subgrp_<cycle_number>
for subsequent cycles.

=back

=head1 CONFIGURABLE STEERING PARAMETERS

=over 4

=item NUMBER = INTEGER

The number of frames in the jitter pattern. [9]

=back

=head1 TIMING

TBS

=head1 IMPLEMENTATION STATUS

=over 4

=item *

The processing engines are from the Starlink packages: CCDPACK
KAPPA, and PISA.

=item *

Uses the Starlink NDF format.

=item *

History is recorded within the data files.

=item *

The title of the data is propagated through intermediate files
to the mosaic.

=item *

Error propagation is not used.

=back

=head1 RELATED RECIPES

L<JITTER5_SELF_FLAT>, L<JITTER5_SELF_FLAT_NO_MASK>, L<JITTER5_SELF_FLAT_APHOT>,
L<JITTER9_SELF_FLAT>, L<JITTER9_SELF_FLAT_NO_MASK>, L<QUADRANT_JITTER>,
L<QUADRANT_JITTER_NO_MASK>.

=head1 REFERENCES

"I<Scripts for UFTI>" G.S. Wright & S.K. Leggett, 1997 orac009-ufts, v01.

=head1 AUTHORS

Malcolm J. Currie (UKATC/JAC) (mjc@jach.hawaii.edu)

=head1 COPYRIGHT

Copyright (C) 1998-2000 Particle Physics and Astronomy Research
Council.  All Rights Reserved.

=cut 
