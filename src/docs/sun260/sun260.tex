\documentclass[twoside,11pt]{article}
% Used for PODs
\def\C++{{\rm C\kern-.05em\raise.3ex\hbox{\footnotesize ++}}}
\def\underscore{\leavevmode\kern.04em\vbox{\hrule width 0.4em height 0.3pt}}
\setlength{\parindent}{0pt}

% +
%  Name:
%     sunxxx.tex

%  Purpose:
%     SUN documentation for ORAC-DR ACSIS pipeline data reduction (SUN/260)

%  Authors:
%     Brad Cavanagh (Joint Astronomy Centre)

%  Copyright:
%     Copyright (C) 2008 Science and Technology Facilities Council.
%     All Rights Reserved.

%  History:
%     $Log$


% -


% ? Specify used packages
\usepackage{graphicx}        %  Use this one for final production.
% \usepackage[draft]{graphicx} %  Use this one for drafting.
% ? End of specify used packages

\pagestyle{myheadings}

% -----------------------------------------------------------------------------
% ? Document identification
% Fixed part
\newcommand{\stardoccategory}  {Starlink User Note}
\newcommand{\stardocinitials}  {SUN}
\newcommand{\stardocsource}    {sun\stardocnumber}
\newcommand{\stardoccopyright} {Copyright \copyright\ 2008 Science and
Technology Facilities Council}

% Variable part - replace [xxx] as appropriate.
\newcommand{\stardocnumber}    {260.1}
\newcommand{\stardocauthors}   {Brad Cavanagh \\
                                Joint Astronomy Centre}
\newcommand{\stardocdate}      {June 2008}
\newcommand{\stardoctitle}     {ORAC-DR -- ACSIS pipeline data reduction}
\newcommand{\stardocversion}   {1.0}
\newcommand{\stardocmanual}    {User Guide}
\newcommand{\stardocabstract}  {ORAC-DR is a
general-purpose automatic data-reduction pipeline environment.  This
document describes its use to reduce ACSIS data
collected at the James Clark Maxwell Telescope (JCMT). }

% ? End of document identification
% -----------------------------------------------------------------------------

% +
%  Name:
%     sun.tex
%
%  Purpose:
%     Template for Starlink User Note (SUN) documents.
%     Refer to SUN/199
%
%  Authors:
%     AJC: A.J.Chipperfield (Starlink, RAL)
%     BLY: M.J.Bly (Starlink, RAL)
%     PWD: Peter W. Draper (Starlink, Durham University)
%
%  History:
%     17-JAN-1996 (AJC):
%        Original with hypertext macros, based on MDL plain originals.
%     16-JUN-1997 (BLY):
%        Adapted for LaTeX2e.
%        Added picture commands.
%     13-AUG-1998 (PWD):
%        Converted for use with LaTeX2HTML version 98.2 and
%        Star2HTML version 1.3.
%      1-FEB-2000 (AJC):
%        Add Copyright statement in LaTeX
%     {Add further history here}
%
% -

\newcommand{\stardocname}{\stardocinitials /\stardocnumber}
\markboth{\stardocname}{\stardocname}
\setlength{\textwidth}{160mm}
\setlength{\textheight}{230mm}
\setlength{\topmargin}{-2mm}
\setlength{\oddsidemargin}{0mm}
\setlength{\evensidemargin}{0mm}
\setlength{\parindent}{0mm}
\setlength{\parskip}{\medskipamount}
\setlength{\unitlength}{1mm}

% -----------------------------------------------------------------------------
%  Hypertext definitions.
%  ======================
%  These are used by the LaTeX2HTML translator in conjunction with star2html.

%  Comment.sty: version 2.0, 19 June 1992
%  Selectively in/exclude pieces of text.
%
%  Author
%    Victor Eijkhout                                      <eijkhout@cs.utk.edu>
%    Department of Computer Science
%    University Tennessee at Knoxville
%    104 Ayres Hall
%    Knoxville, TN 37996
%    USA

%  Do not remove the %begin{latexonly} and %end{latexonly} lines (used by
%  LaTeX2HTML to signify text it shouldn't process).
%begin{latexonly}
\makeatletter
\def\makeinnocent#1{\catcode`#1=12 }
\def\csarg#1#2{\expandafter#1\csname#2\endcsname}

\def\ThrowAwayComment#1{\begingroup
    \def\CurrentComment{#1}%
    \let\do\makeinnocent \dospecials
    \makeinnocent\^^L% and whatever other special cases
    \endlinechar`\^^M \catcode`\^^M=12 \xComment}
{\catcode`\^^M=12 \endlinechar=-1 %
 \gdef\xComment#1^^M{\def\test{#1}
      \csarg\ifx{PlainEnd\CurrentComment Test}\test
          \let\html@next\endgroup
      \else \csarg\ifx{LaLaEnd\CurrentComment Test}\test
            \edef\html@next{\endgroup\noexpand\end{\CurrentComment}}
      \else \let\html@next\xComment
      \fi \fi \html@next}
}
\makeatother

\def\includecomment
 #1{\expandafter\def\csname#1\endcsname{}%
    \expandafter\def\csname end#1\endcsname{}}
\def\excludecomment
 #1{\expandafter\def\csname#1\endcsname{\ThrowAwayComment{#1}}%
    {\escapechar=-1\relax
     \csarg\xdef{PlainEnd#1Test}{\string\\end#1}%
     \csarg\xdef{LaLaEnd#1Test}{\string\\end\string\{#1\string\}}%
    }}

%  Define environments that ignore their contents.
\excludecomment{comment}
\excludecomment{rawhtml}
\excludecomment{htmlonly}

%  Hypertext commands etc. This is a condensed version of the html.sty
%  file supplied with LaTeX2HTML by: Nikos Drakos <nikos@cbl.leeds.ac.uk> &
%  Jelle van Zeijl <jvzeijl@isou17.estec.esa.nl>. The LaTeX2HTML documentation
%  should be consulted about all commands (and the environments defined above)
%  except \xref and \xlabel which are Starlink specific.

\newcommand{\htmladdnormallinkfoot}[2]{#1\footnote{#2}}
\newcommand{\htmladdnormallink}[2]{#1}
\newcommand{\htmladdimg}[1]{}
\newcommand{\hyperref}[4]{#2\ref{#4}#3}
\newcommand{\htmlref}[2]{#1}
\newcommand{\htmlimage}[1]{}
\newcommand{\htmladdtonavigation}[1]{}

\newenvironment{latexonly}{}{}
\newcommand{\latex}[1]{#1}
\newcommand{\html}[1]{}
\newcommand{\latexhtml}[2]{#1}
\newcommand{\HTMLcode}[2][]{}

%  Starlink cross-references and labels.
\newcommand{\xref}[3]{#1}
\newcommand{\xlabel}[1]{}

%  LaTeX2HTML symbol.
\newcommand{\latextohtml}{\LaTeX2\texttt{HTML}}

%  Define command to re-centre underscore for Latex and leave as normal
%  for HTML (severe problems with \_ in tabbing environments and \_\_
%  generally otherwise).
\renewcommand{\_}{\texttt{\symbol{95}}}

% -----------------------------------------------------------------------------
%  Debugging.
%  =========
%  Remove % on the following to debug links in the HTML version using Latex.

% \newcommand{\hotlink}[2]{\fbox{\begin{tabular}[t]{@{}c@{}}#1\\\hline{\footnotesize #2}\end{tabular}}}
% \renewcommand{\htmladdnormallinkfoot}[2]{\hotlink{#1}{#2}}
% \renewcommand{\htmladdnormallink}[2]{\hotlink{#1}{#2}}
% \renewcommand{\hyperref}[4]{\hotlink{#1}{\S\ref{#4}}}
% \renewcommand{\htmlref}[2]{\hotlink{#1}{\S\ref{#2}}}
% \renewcommand{\xref}[3]{\hotlink{#1}{#2 -- #3}}
%end{latexonly}
% -----------------------------------------------------------------------------
% ? Document specific \newcommand or \newenvironment commands.

\newcommand{\CCDPACK}{\xref{{\sc{Ccdpack}}}{sun139}{}}
\newcommand{\GAIA}{\xref{{\sc{Gaia}}}{sun214}{}}
\newcommand{\FIGARO}{\xref{{\sc{Figaro}}}{sun86}{}}
\newcommand{\KAPPA}{\xref{{\sc{Kappa}}}{sun95}{}}
\newcommand{\SMURF}{\xref{{\sc{Smurf}}}{sun258}{}}
\newcommand{\ORACDR}{{\footnotesize ORAC-DR}}


% ? End of document specific commands
% -----------------------------------------------------------------------------
%  Title Page.
%  ===========
\renewcommand{\thepage}{\roman{page}}
\begin{document}
\setcounter{secnumdepth}{5}
\thispagestyle{empty}

%  Latex document header.
%  ======================
\begin{latexonly}
   \textsc{Joint Astronomy Centre} \hfill \textbf{\stardocname}\\
   {\large Science and Technology Facilities Council}\\
   {\large Starlink Project\\ }
   {\large \stardoccategory\ \stardocnumber}
   \begin{flushright}
   \stardocauthors\\
   \stardocdate
   \end{flushright}
   \vspace{-4mm}
   \rule{\textwidth}{0.5mm}
   \vspace{5mm}
   \begin{center}
   {\Huge\textbf{\stardoctitle \\ [2.5ex]}}
   {\LARGE\textbf{\stardocversion \\ [4ex]}}
   {\Huge\textbf{\stardocmanual}}
   \end{center}
   \vspace{5mm}

% ? Add picture here if required for the LaTeX version.
%   e.g. \includegraphics[scale=0.3]{filename.ps}
\begin{center}
\includegraphics[width=1.0in]{sun260_logo.eps}
\end{center}
% ? End of picture

% ? Heading for abstract if used.
   \vspace{10mm}
   \begin{center}
      {\Large\textbf{Abstract}}
   \end{center}
% ? End of heading for abstract.
\end{latexonly}

%  HTML documentation header.
%  ==========================
\begin{htmlonly}
   \xlabel{}
   \begin{rawhtml} <H1> \end{rawhtml}
      \stardoctitle\\
      \stardocversion\\
      \stardocmanual
   \begin{rawhtml} </H1> <HR> \end{rawhtml}

% ? Add picture here if required for the hypertext version.
%   e.g. \includegraphics[scale=0.7]{filename.ps}
\includegraphics[width=1.0in]{sun260_logo.eps}
% ? End of picture

   \begin{rawhtml} <P> <I> \end{rawhtml}
   \stardoccategory\ \stardocnumber \\
   \stardocauthors \\
   \stardocdate
   \begin{rawhtml} </I> </P> <H3> \end{rawhtml}
      \htmladdnormallink{Joint Astronomy Centre}
                        {http://www.jach.hawaii.edu/} \\
      \htmladdnormallink{Science and Technology Facilities Council}
                        {http://www.scitech.ac.uk/} \\
   \begin{rawhtml} </H3> <H2> \end{rawhtml}
      \htmladdnormallink{Starlink Project}{http://www.starlink.rl.ac.uk/}
   \begin{rawhtml} </H2> \end{rawhtml}
   \htmladdnormallink{\htmladdimg{source.gif} Retrieve hardcopy}
      {http://www.starlink.rl.ac.uk/cgi-bin/hcserver?\stardocsource}\\

%  HTML document table of contents.
%  ================================
%  Add table of contents header and a navigation button to return to this
%  point in the document (this should always go before the abstract \section).
  \label{stardoccontents}
  \begin{rawhtml}
    <HR>
    <H2>Contents</H2>
  \end{rawhtml}
  \htmladdtonavigation{\htmlref{\htmladdimg{contents_motif.gif}}
        {stardoccontents}}

% ? New section for abstract if used.
  \section{\xlabel{abstract}Abstract}
% ? End of new section for abstract
\end{htmlonly}

% -----------------------------------------------------------------------------
% ? Document Abstract. (if used)
%  ==================
\stardocabstract
% ? End of document abstract

% -----------------------------------------------------------------------------
% ? Latex Copyright Statement
%  =========================
\begin{latexonly}
\newpage
\vspace*{\fill}
\stardoccopyright
\end{latexonly}
% ? End of Latex copyright statement

% -----------------------------------------------------------------------------
% ? Latex document Table of Contents (if used).
%  ===========================================
  \newpage
  \begin{latexonly}
    \setlength{\parskip}{0mm}
    \tableofcontents
    \setlength{\parskip}{\medskipamount}
    \markboth{\stardocname}{\stardocname}
  \end{latexonly}
% ? End of Latex document table of contents
% -----------------------------------------------------------------------------

\cleardoublepage
\renewcommand{\thepage}{\arabic{page}}
\setcounter{page}{1}



\section{Introduction}



\section{Running ORAC-DR}

This is a very brief introduction to running \ORACDR. More detailed
information can be found in \xref{SUN/230}{sun230}{}.
\xref{SUN/232}{sun232}{} also includes a description of how to set up
and run \ORACDR.

You must first initialise \ORACDR\ using {\tt oracdr\_acsis}. This will
prepare \ORACDR\ to reduce data taken that night. If
you wish to reduce a previous nights data then you should specify the
UT date on the command line, e.g.\ {\tt oracdr\_acsis 20080616}. If
necessary, you should set the {\tt \$ORAC\_DATA\_IN} and {\tt
  \$ORAC\_DATA\_OUT} environment variables to the names of the
directories from which the raw data should be read and to which reduced
data should be written.

For example:

\begin{verbatim}
      % oracdr_acsis 20080616
      % setenv ORAC_DATA_IN /jcmtdata/raw/acsis/spectra/20080616
      % setenv ORAC_DATA_OUT /home/bradc/data/oracdr/reduced/acsis/20080616
\end{verbatim}

To reduce all data taken so far and then all data as it is stored you
should run

\begin{verbatim}
      oracdr -loop flag -skip
\end{verbatim}

Several windows will (eventually) open: an \ORACDR\ text display, \GAIA\
windows and \textsc{Kapview} windows (a collective term for various
\KAPPA\ display tasks). The pipeline will reduce the data as they
are stored to disk, using the recipe name in the image header.

The pipeline is meant to run without interference from the observer.
Thus, although you can use the various \GAIA\ tools to examine images,
the pipeline should not need to be stopped and/or restarted. If,
however, you do need to restart the pipeline then this can be done
using the {\tt -from} option on the command line:

\begin{verbatim}
      oracdr -loop flag -from 19 -skip
\end{verbatim}

This will re-reduce frames from 19 onwards if they have previously
been reduced, then continue to wait for new frames to arrive. The {\tt
  -loop flag} tells it not to exit when it runs out of frames. When
reducing data off-line this should be omitted. The {\tt -skip} tells it to
skip missing observations.

To re-reduce a group of
previously stored frames you can use the {\tt -list} option to specify
a list of frames separated by commas or ranges separated by colons:

\begin{verbatim}
      oracdr -list 15,18:20
\end{verbatim}

You may choose to reduce your data with a recipe other than the one specified
in the file headers. If you discover narrow-line data reduction produces
better maps than the {\tt REDUCE\_SCIENCE\_GRADIENT} recipe does, you may wish
to specify the {\tt REDUCE\_SCIENCE\_NARROWLINE} recipe on the command line,
for example:

\begin{verbatim}
      oracdr -loop flag -list 18:20 REDUCE\_SCIENCE\_NARROWLINE
\end{verbatim}

Further, advanced recipes are available to perform more advanced and rigorous
data reduction than is normally carried out in real-time at the telescope. To
use these recipes, supply the {\tt -recsuffix ADV} command-line option:

\begin{verbatim}
      oracdr -list 18:20 -recsuffix ADV
\end{verbatim}

The chief advantage to using the {\tt -recsuffix ADV} option instead of
supplying the full recipe on the command-line is if the advanced recipe does
not exist, the default standard recipe will be used instead. Thus you need not
fear reducing pointing observations using a recipe designed for science
targets.

To exit (or abort) \ORACDR\ click on `Exit' in the text log window, or
type {\tt [ctrl]-c} in the xterm. The command {\tt oracdr\_nuke} can
be used to kill all DR-related processes, should you be having
problems.

\section{ACSIS Data}

ACSIS data comes in two forms: time-series cubes and spatial/spectral
cubes. Time-series cubes have frequency on the first axis, detector on the
second, and time on the third. As data comes in off the telescope, the time
slices are written to disk. Because data acquisition is asynchronous, time
slices are not necessarily written in sequential order. Further, there is a
500-megabyte size limit for raw data files, more than one file can be written
per observation. These files are called {\bf subscans}.

ACSIS can be configured to take data at two (or more) frequencies or bandwidth
modes at the same time in different {\bf subsystems}. Subsystems are treated
as individual and separate observations by \ORACDR\, except for {\bf hybrid
mode} observations, where two (or four, for RxA, RxB, and RxW) subsystems are
set up to overlap in frequency space in such a way that overlapping channels
observe the same frequency.

Astronomers would rather deal with spatial/spectral cubes (heretofor referred
to as {\bf cubes} -- when time-series cubes are discussed they will be called
{\bf time-series cubes} instead of time-series cubes. Time-series cubes are
regridded onto a spatial grid, creating a cube with right ascension and
declination on the first two axes and frequency on the third.

\section{An overview of the reduction}

The data reduction for ACSIS depends on the type of data being
reduced. Calibration observations (pointings, focus, and flux calibrators) are
reduced differently from science observations. Further, science observations
are reduced differently based on what type of science is being done; planetary
continuum observations have different processing steps from line sources.

\subsection{Pointing observations}

Pointing observations are used to ensure that the telescope is pointing in the
correct location.

In reducing pointing observations, two different methods are done. The first
assumes that a continuum source has been observed, and the second assumes that
a line source has been observed.

In both modes, the time-series data are first regridded to form a cube. In
continuum mode, the spectral regions lacking lines are collapsed to form an
image, and in line mode the line regions are collapsed to form an image. If a
five-position pointing is done, then a Gaussian is fit to horizontal and
vertical cuts (which correspond to azimuth and elevation) to determine the
location of the pointing source. Otherwise, centroiding is done on the
source. The calculated pointing offset is then reported to the user.

\subsection{Focus observations}

Focus observations are used to ensure that the telescope is focussed.

\ORACDR\ currently does not calculate any focus measurements. The time-series
data are only regridded to form a cube.

\subsection{Flux calibrator observations}

\subsection{Line source science observations}

\subsection{Continuum source science observations}

\section{Displaying reconstructed cubes and images}

ORAC-DR automatically displays selected cubes, images, and spectra during its

\section{Variance propagation}

\section{Data files}

\subsection{Filenames and locations}

\subsection{File suffixes}

\textbf{Frame suffixes}

\vspace{0.2cm}

\begin{tabular}{l c l}
\hline
Suffix & Kept & Description \hspace{9cm}  \\
\hline
{\tt \_raw} & Y & The raw frame\\
{\tt \_adu} & Y & Scaled to ADUs\\
{\tt \_sbf} & N & Bias frame subtracted\\
{\tt \_pov} & N & Poisson variance added\\
{\tt \_rnv} & N & Readnoise variance added\\
{\tt \_bgl} & N & Shows which pixels are background limited\\
{\tt \_bp}  & N & Bad pixels masked\\
{\tt \_ext} & Y & Slices extracted and approximately aligned\\
{\tt \_ff}  & N & Flat fielded\\
{\tt \_nf}  & Y & Normalised flat\\
{\tt \_bpf} & N & Pixels previously marked as bad filled with
interpolated values\\
{\tt \_ss}  & N & sky-subtracted\\
{\tt \_scr} & Y & All rows scrunched to common wavelength scale\\
{\tt \_cub} & Y & Formed into a datacube\\
{\tt \_dbsc} & N & All spectra in datacube divided by standard\\
{\tt \_im}  & Y & Image extracted from datacube\\
\hline
\end{tabular}

\vspace{0.5cm}

\textbf{Group suffixes}

\vspace{0.2cm}

\begin{tabular}{l c l}
\hline
Suffix & Kept & Description \hspace{9cm} \\
\hline
{\tt \_scr} & Y & All rows scrunched to common wavelength scale\\
{\tt \_cub} & Y & Formed into a datacube\\
{\tt \_mos} & Y & Mosaicked datacube\\
{\tt \_dbsc} & Y & All spectra in datacube divided by standard\\
{\tt \_im}  & Y & Image extracted from datacube\\
\hline
\end{tabular}

\clearpage

%\appendix

\section{Recipes}

\subsection{EXTENDED\_SOURCE}

\subsubsection*{Description\index{Description}}

\subsubsection*{Notes\index{Notes}}

\subsubsection*{Output data}

\clearpage

\end{document}
